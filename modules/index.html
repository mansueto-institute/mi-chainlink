
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A flexible record linkage framework that enables matching between multiple datasets using both exact and fuzzy matching techniques.">
      
      
        <meta name="author" content="Mansueto Institute,Austin Steinhart">
      
      
        <link rel="canonical" href="https://mansueto-institute.github.io/mi-chainlink/modules/">
      
      
        <link rel="prev" href="../output-db-schema/">
      
      
        <link rel="next" href="../contributing/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>API - chainlink</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chainlink" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="chainlink" class="md-header__button md-logo" aria-label="chainlink" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            chainlink
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="deep-orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/mansueto-institute/mi-chainlink" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    mansueto-institute/mi-chainlink
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="chainlink" class="md-nav__button md-logo" aria-label="chainlink" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    chainlink
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mansueto-institute/mi-chainlink" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    mansueto-institute/mi-chainlink
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../advanced-features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Advanced Features
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../output-db-schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Output Database Schema
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chainlink" class="md-nav__link">
    <span class="md-ellipsis">
      chainlink
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chainlink.cleaning" class="md-nav__link">
    <span class="md-ellipsis">
      cleaning
    </span>
  </a>
  
    <nav class="md-nav" aria-label="cleaning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.cleaning.cleaning_functions" class="md-nav__link">
    <span class="md-ellipsis">
      cleaning_functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="cleaning_functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.cleaning.cleaning_functions.clean_address" class="md-nav__link">
    <span class="md-ellipsis">
      clean_address
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.cleaning.cleaning_functions.clean_names" class="md-nav__link">
    <span class="md-ellipsis">
      clean_names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.cleaning.cleaning_functions.clean_zipcode" class="md-nav__link">
    <span class="md-ellipsis">
      clean_zipcode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.cleaning.cleaning_functions.identify_state_city" class="md-nav__link">
    <span class="md-ellipsis">
      identify_state_city
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.cleaning.cleaning_functions.predict_org" class="md-nav__link">
    <span class="md-ellipsis">
      predict_org
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.cleaning.cleaning_functions.remove_initial_I" class="md-nav__link">
    <span class="md-ellipsis">
      remove_initial_I
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chainlink.link" class="md-nav__link">
    <span class="md-ellipsis">
      link
    </span>
  </a>
  
    <nav class="md-nav" aria-label="link">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_generic" class="md-nav__link">
    <span class="md-ellipsis">
      link_generic
    </span>
  </a>
  
    <nav class="md-nav" aria-label="link_generic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_generic.create_across_links" class="md-nav__link">
    <span class="md-ellipsis">
      create_across_links
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_generic.create_tfidf_across_links" class="md-nav__link">
    <span class="md-ellipsis">
      create_tfidf_across_links
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_generic.create_tfidf_within_links" class="md-nav__link">
    <span class="md-ellipsis">
      create_tfidf_within_links
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_generic.create_within_links" class="md-nav__link">
    <span class="md-ellipsis">
      create_within_links
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils" class="md-nav__link">
    <span class="md-ellipsis">
      link_utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="link_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.execute_address_fuzzy_link" class="md-nav__link">
    <span class="md-ellipsis">
      execute_address_fuzzy_link
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.execute_fuzzy_link" class="md-nav__link">
    <span class="md-ellipsis">
      execute_fuzzy_link
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.execute_match" class="md-nav__link">
    <span class="md-ellipsis">
      execute_match
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.execute_match_address" class="md-nav__link">
    <span class="md-ellipsis">
      execute_match_address
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.execute_match_processing" class="md-nav__link">
    <span class="md-ellipsis">
      execute_match_processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.execute_match_unit" class="md-nav__link">
    <span class="md-ellipsis">
      execute_match_unit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.generate_combos_within_across_tables" class="md-nav__link">
    <span class="md-ellipsis">
      generate_combos_within_across_tables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.generate_tfidf_links" class="md-nav__link">
    <span class="md-ellipsis">
      generate_tfidf_links
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.query_append_to_links" class="md-nav__link">
    <span class="md-ellipsis">
      query_append_to_links
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.tfidf_utils" class="md-nav__link">
    <span class="md-ellipsis">
      tfidf_utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tfidf_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.link.tfidf_utils.adjust_and_replace" class="md-nav__link">
    <span class="md-ellipsis">
      adjust_and_replace
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.tfidf_utils.clean_matches" class="md-nav__link">
    <span class="md-ellipsis">
      clean_matches
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.tfidf_utils.database_query" class="md-nav__link">
    <span class="md-ellipsis">
      database_query
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.tfidf_utils.get_matches_df" class="md-nav__link">
    <span class="md-ellipsis">
      get_matches_df
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.tfidf_utils.ngrams" class="md-nav__link">
    <span class="md-ellipsis">
      ngrams
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.tfidf_utils.superfast_tfidf" class="md-nav__link">
    <span class="md-ellipsis">
      superfast_tfidf
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chainlink.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_generic" class="md-nav__link">
    <span class="md-ellipsis">
      load_generic
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_generic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_generic.load_generic" class="md-nav__link">
    <span class="md-ellipsis">
      load_generic
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils" class="md-nav__link">
    <span class="md-ellipsis">
      load_utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils.clean_generic" class="md-nav__link">
    <span class="md-ellipsis">
      clean_generic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils.create_id_col" class="md-nav__link">
    <span class="md-ellipsis">
      create_id_col
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils.execute_flag_bad_addresses" class="md-nav__link">
    <span class="md-ellipsis">
      execute_flag_bad_addresses
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils.load_to_db" class="md-nav__link">
    <span class="md-ellipsis">
      load_to_db
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_to_db">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils.load_to_db--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils.load_to_db--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils.update_entity_ids" class="md-nav__link">
    <span class="md-ellipsis">
      update_entity_ids
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils.validate_input_data" class="md-nav__link">
    <span class="md-ellipsis">
      validate_input_data
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chainlink.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
    <nav class="md-nav" aria-label="main">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.main.chainlink" class="md-nav__link">
    <span class="md-ellipsis">
      chainlink
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.main.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chainlink.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.add_schema_config" class="md-nav__link">
    <span class="md-ellipsis">
      add_schema_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.add_table_config" class="md-nav__link">
    <span class="md-ellipsis">
      add_table_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.check_table_exists" class="md-nav__link">
    <span class="md-ellipsis">
      check_table_exists
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.create_config" class="md-nav__link">
    <span class="md-ellipsis">
      create_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.export_tables" class="md-nav__link">
    <span class="md-ellipsis">
      export_tables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.load_config" class="md-nav__link">
    <span class="md-ellipsis">
      load_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.setup_logger" class="md-nav__link">
    <span class="md-ellipsis">
      setup_logger
    </span>
  </a>
  
    <nav class="md-nav" aria-label="setup_logger">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.setup_logger--from-httpsstackoverflowcomquestions11232230logging-to-two-files-with-different-settings" class="md-nav__link">
    <span class="md-ellipsis">
      from https://stackoverflow.com/questions/11232230/logging-to-two-files-with-different-settings
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.update_config" class="md-nav__link">
    <span class="md-ellipsis">
      update_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.validate_config" class="md-nav__link">
    <span class="md-ellipsis">
      validate_config
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chainlink" class="md-nav__link">
    <span class="md-ellipsis">
      chainlink
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chainlink.cleaning" class="md-nav__link">
    <span class="md-ellipsis">
      cleaning
    </span>
  </a>
  
    <nav class="md-nav" aria-label="cleaning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.cleaning.cleaning_functions" class="md-nav__link">
    <span class="md-ellipsis">
      cleaning_functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="cleaning_functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.cleaning.cleaning_functions.clean_address" class="md-nav__link">
    <span class="md-ellipsis">
      clean_address
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.cleaning.cleaning_functions.clean_names" class="md-nav__link">
    <span class="md-ellipsis">
      clean_names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.cleaning.cleaning_functions.clean_zipcode" class="md-nav__link">
    <span class="md-ellipsis">
      clean_zipcode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.cleaning.cleaning_functions.identify_state_city" class="md-nav__link">
    <span class="md-ellipsis">
      identify_state_city
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.cleaning.cleaning_functions.predict_org" class="md-nav__link">
    <span class="md-ellipsis">
      predict_org
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.cleaning.cleaning_functions.remove_initial_I" class="md-nav__link">
    <span class="md-ellipsis">
      remove_initial_I
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chainlink.link" class="md-nav__link">
    <span class="md-ellipsis">
      link
    </span>
  </a>
  
    <nav class="md-nav" aria-label="link">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_generic" class="md-nav__link">
    <span class="md-ellipsis">
      link_generic
    </span>
  </a>
  
    <nav class="md-nav" aria-label="link_generic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_generic.create_across_links" class="md-nav__link">
    <span class="md-ellipsis">
      create_across_links
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_generic.create_tfidf_across_links" class="md-nav__link">
    <span class="md-ellipsis">
      create_tfidf_across_links
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_generic.create_tfidf_within_links" class="md-nav__link">
    <span class="md-ellipsis">
      create_tfidf_within_links
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_generic.create_within_links" class="md-nav__link">
    <span class="md-ellipsis">
      create_within_links
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils" class="md-nav__link">
    <span class="md-ellipsis">
      link_utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="link_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.execute_address_fuzzy_link" class="md-nav__link">
    <span class="md-ellipsis">
      execute_address_fuzzy_link
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.execute_fuzzy_link" class="md-nav__link">
    <span class="md-ellipsis">
      execute_fuzzy_link
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.execute_match" class="md-nav__link">
    <span class="md-ellipsis">
      execute_match
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.execute_match_address" class="md-nav__link">
    <span class="md-ellipsis">
      execute_match_address
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.execute_match_processing" class="md-nav__link">
    <span class="md-ellipsis">
      execute_match_processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.execute_match_unit" class="md-nav__link">
    <span class="md-ellipsis">
      execute_match_unit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.generate_combos_within_across_tables" class="md-nav__link">
    <span class="md-ellipsis">
      generate_combos_within_across_tables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.generate_tfidf_links" class="md-nav__link">
    <span class="md-ellipsis">
      generate_tfidf_links
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.link_utils.query_append_to_links" class="md-nav__link">
    <span class="md-ellipsis">
      query_append_to_links
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.tfidf_utils" class="md-nav__link">
    <span class="md-ellipsis">
      tfidf_utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tfidf_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.link.tfidf_utils.adjust_and_replace" class="md-nav__link">
    <span class="md-ellipsis">
      adjust_and_replace
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.tfidf_utils.clean_matches" class="md-nav__link">
    <span class="md-ellipsis">
      clean_matches
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.tfidf_utils.database_query" class="md-nav__link">
    <span class="md-ellipsis">
      database_query
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.tfidf_utils.get_matches_df" class="md-nav__link">
    <span class="md-ellipsis">
      get_matches_df
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.tfidf_utils.ngrams" class="md-nav__link">
    <span class="md-ellipsis">
      ngrams
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.link.tfidf_utils.superfast_tfidf" class="md-nav__link">
    <span class="md-ellipsis">
      superfast_tfidf
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chainlink.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_generic" class="md-nav__link">
    <span class="md-ellipsis">
      load_generic
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_generic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_generic.load_generic" class="md-nav__link">
    <span class="md-ellipsis">
      load_generic
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils" class="md-nav__link">
    <span class="md-ellipsis">
      load_utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils.clean_generic" class="md-nav__link">
    <span class="md-ellipsis">
      clean_generic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils.create_id_col" class="md-nav__link">
    <span class="md-ellipsis">
      create_id_col
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils.execute_flag_bad_addresses" class="md-nav__link">
    <span class="md-ellipsis">
      execute_flag_bad_addresses
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils.load_to_db" class="md-nav__link">
    <span class="md-ellipsis">
      load_to_db
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_to_db">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils.load_to_db--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils.load_to_db--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils.update_entity_ids" class="md-nav__link">
    <span class="md-ellipsis">
      update_entity_ids
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.load.load_utils.validate_input_data" class="md-nav__link">
    <span class="md-ellipsis">
      validate_input_data
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chainlink.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
    <nav class="md-nav" aria-label="main">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.main.chainlink" class="md-nav__link">
    <span class="md-ellipsis">
      chainlink
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.main.main" class="md-nav__link">
    <span class="md-ellipsis">
      main
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chainlink.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.add_schema_config" class="md-nav__link">
    <span class="md-ellipsis">
      add_schema_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.add_table_config" class="md-nav__link">
    <span class="md-ellipsis">
      add_table_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.check_table_exists" class="md-nav__link">
    <span class="md-ellipsis">
      check_table_exists
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.create_config" class="md-nav__link">
    <span class="md-ellipsis">
      create_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.export_tables" class="md-nav__link">
    <span class="md-ellipsis">
      export_tables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.load_config" class="md-nav__link">
    <span class="md-ellipsis">
      load_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.setup_logger" class="md-nav__link">
    <span class="md-ellipsis">
      setup_logger
    </span>
  </a>
  
    <nav class="md-nav" aria-label="setup_logger">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.setup_logger--from-httpsstackoverflowcomquestions11232230logging-to-two-files-with-different-settings" class="md-nav__link">
    <span class="md-ellipsis">
      from https://stackoverflow.com/questions/11232230/logging-to-two-files-with-different-settings
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.update_config" class="md-nav__link">
    <span class="md-ellipsis">
      update_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chainlink.utils.validate_config" class="md-nav__link">
    <span class="md-ellipsis">
      validate_config
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>API</h1>

<div class="doc doc-object doc-module">



<a id="chainlink"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h2 id="chainlink.cleaning" class="doc doc-heading">
            <code>cleaning</code>


<a href="#chainlink.cleaning" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="chainlink.cleaning.cleaning_functions" class="doc doc-heading">
            <code>cleaning_functions</code>


<a href="#chainlink.cleaning.cleaning_functions" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="chainlink.cleaning.cleaning_functions.clean_address" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clean_address</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span></code>

<a href="#chainlink.cleaning.cleaning_functions.clean_address" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Given a raw address, first conduct baseline address cleaning, then
identify and return the components of the address. Where possible, infer
correct city and state value from the zip code given.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raw</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A raw address.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary of address components.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/cleaning/cleaning_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clean_address</span><span class="p">(</span><span class="n">raw</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a raw address, first conduct baseline address cleaning, then</span>
<span class="sd">    identify and return the components of the address. Where possible, infer</span>
<span class="sd">    correct city and state value from the zip code given.</span>

<span class="sd">    Args:</span>
<span class="sd">        raw (str): A raw address.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary of address components.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">raw</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="n">raw</span><span class="p">,</span>
            <span class="s2">&quot;address_number&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;street_pre_directional&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;street_name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;street_post_type&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;unit_type&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;unit_number&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;subaddress_type&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;subaddress_identifier&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;postal_code&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;street&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;address_norm&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">FIELD_NAMES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;AddressNumber&quot;</span><span class="p">,</span>
        <span class="s2">&quot;StreetNamePreDirectional&quot;</span><span class="p">,</span>
        <span class="s2">&quot;StreetName&quot;</span><span class="p">,</span>
        <span class="s2">&quot;StreetNamePostType&quot;</span><span class="p">,</span>
        <span class="s2">&quot;OccupancyType&quot;</span><span class="p">,</span>
        <span class="s2">&quot;OccupancyIdentifier&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SubaddressType&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SubaddressIdentifier&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PlaceName&quot;</span><span class="p">,</span>
        <span class="s2">&quot;StateName&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ZipCode&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># remove spaces and punct</span>
    <span class="n">raw_stripped</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;,|\.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c1"># replace # with UNIT</span>
    <span class="n">to_normalize</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot; UNIT &quot;</span><span class="p">,</span> <span class="n">raw_stripped</span><span class="p">)</span>
    <span class="c1"># replace multiple spaces with single space</span>
    <span class="n">to_normalize</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">to_normalize</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">normalized</span> <span class="o">=</span> <span class="n">normalize_address_record</span><span class="p">(</span><span class="n">to_normalize</span><span class="p">)</span>
        <span class="n">normalized</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">normalized</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">normalized</span> <span class="o">=</span> <span class="n">to_normalize</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">usaddress</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># retain any successfully parsed fields</span>
    <span class="k">except</span> <span class="n">usaddress</span><span class="o">.</span><span class="n">RepeatedLabelError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">parsed_field</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">parsed_string</span><span class="p">:</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">parsed_field</span>

            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">FIELD_NAMES</span><span class="p">:</span>
                <span class="n">tags</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">record</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="n">raw</span><span class="p">,</span>
        <span class="s2">&quot;address_number&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AddressNumber&quot;</span><span class="p">),</span>
        <span class="s2">&quot;street_pre_directional&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;StreetNamePreDirectional&quot;</span><span class="p">),</span>
        <span class="s2">&quot;street_name&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;StreetName&quot;</span><span class="p">),</span>
        <span class="s2">&quot;street_post_type&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;StreetNamePostType&quot;</span><span class="p">),</span>
        <span class="s2">&quot;unit_type&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OccupancyType&quot;</span><span class="p">),</span>
        <span class="s2">&quot;unit_number&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OccupancyIdentifier&quot;</span><span class="p">),</span>
        <span class="s2">&quot;subaddress_type&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SubaddressType&quot;</span><span class="p">),</span>
        <span class="s2">&quot;subaddress_identifier&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SubaddressIdentifier&quot;</span><span class="p">),</span>
        <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PlaceName&quot;</span><span class="p">),</span>
        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;StateName&quot;</span><span class="p">),</span>
        <span class="s2">&quot;postal_code&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ZipCode&quot;</span><span class="p">),</span>
        <span class="s2">&quot;address_norm&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9]+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()),</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">record</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^A-z\s]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;street_name&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">record</span><span class="p">[</span><span class="s2">&quot;street_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;,\.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;street_name&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># Remove unit from street name for cases where the address parser</span>
        <span class="c1"># erroneously included it</span>
        <span class="n">record</span><span class="p">[</span><span class="s2">&quot;street_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;UNIT.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;street_name&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;street_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="s2">&quot;street_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;unit_number&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">record</span><span class="p">[</span><span class="s2">&quot;unit_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^[A-z0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;unit_number&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;unit_number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="s2">&quot;unit_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Overwrite city and state using uszip if the parsed state is not valid</span>
    <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state_abbr</span> <span class="ow">or</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">zip_city</span><span class="p">,</span> <span class="n">zip_state</span> <span class="o">=</span> <span class="n">identify_state_city</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;postal_code&quot;</span><span class="p">])</span>

        <span class="c1"># if don&#39;t find valid city, state, leave original</span>
        <span class="k">if</span> <span class="n">zip_city</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zip_city</span>

        <span class="k">if</span> <span class="n">zip_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zip_state</span>

    <span class="n">street_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;address_number&quot;</span><span class="p">,</span>
        <span class="s2">&quot;street_pre_directional&quot;</span><span class="p">,</span>
        <span class="s2">&quot;street_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;street_post_type&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">record</span><span class="p">[</span><span class="s2">&quot;street&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
        <span class="n">record</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">street_fields</span> <span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;street&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;street&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">):</span>
        <span class="n">record</span><span class="p">[</span><span class="s2">&quot;street&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">suffixes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;street_post_type&quot;</span><span class="p">]):</span>
        <span class="n">record</span><span class="p">[</span><span class="s2">&quot;street_post_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">suffixes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;street_post_type&quot;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">value</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Force everything to a Python string:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">record</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">record</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.cleaning.cleaning_functions.clean_names" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clean_names</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span></code>

<a href="#chainlink.cleaning.cleaning_functions.clean_names" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Given a raw name string, clean the name and return it. Contains conditional
logic based on the source of the data to handle data-specific cleaning cases.
Returns none if the name resembles a list of excluded strings. Strips
most non-alphanumeric characters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raw</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A raw name string.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A cleaned name string.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/cleaning/cleaning_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clean_names</span><span class="p">(</span><span class="n">raw</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a raw name string, clean the name and return it. Contains conditional</span>
<span class="sd">    logic based on the source of the data to handle data-specific cleaning cases.</span>
<span class="sd">    Returns none if the name resembles a list of excluded strings. Strips</span>
<span class="sd">    most non-alphanumeric characters.</span>

<span class="sd">    Args:</span>
<span class="sd">        raw (str): A raw name string.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: A cleaned name string.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">EXCLUDED_PATTERNS</span><span class="p">,</span> <span class="n">raw</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;AND&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="s2">&quot;AT&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9\s]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s{2,}&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span>
    <span class="k">return</span> <span class="n">name</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.cleaning.cleaning_functions.clean_zipcode" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clean_zipcode</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span></code>

<a href="#chainlink.cleaning.cleaning_functions.clean_zipcode" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Modified from the function written by Anthony Moser of the deseguys project.</p>
<p>Returns a 5-digit zipcode from a string.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raw</code>
            </td>
            <td>
                  <code><span title="any">any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A zipcode.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A 5-digit zipcode or an empty string.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/cleaning/cleaning_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clean_zipcode</span><span class="p">(</span><span class="n">raw</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modified from the function written by Anthony Moser of the deseguys project.</span>

<span class="sd">    Returns a 5-digit zipcode from a string.</span>

<span class="sd">    Args:</span>
<span class="sd">        raw (any): A zipcode.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: A 5-digit zipcode or an empty string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">zipcode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">raw</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">zipcode</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.cleaning.cleaning_functions.identify_state_city" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">identify_state_city</span><span class="p">(</span><span class="n">zipcode</span><span class="p">)</span></code>

<a href="#chainlink.cleaning.cleaning_functions.identify_state_city" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Use zipcode to look up state and city info using the uszipcode API.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>zipcode</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A zipcode.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tuple</code></td>            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple of city and state, or (None, None) if the lookup failed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/cleaning/cleaning_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">identify_state_city</span><span class="p">(</span><span class="n">zipcode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use zipcode to look up state and city info using the uszipcode API.</span>

<span class="sd">    Args:</span>
<span class="sd">        zipcode (str): A zipcode.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple of city and state, or (None, None) if the lookup failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zipcode</span> <span class="o">=</span> <span class="n">clean_zipcode</span><span class="p">(</span><span class="n">zipcode</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">zipcode</span> <span class="ow">in</span> <span class="n">zip_cache</span><span class="p">:</span>
            <span class="n">zip_city</span> <span class="o">=</span> <span class="n">zip_cache</span><span class="p">[</span><span class="n">zipcode</span><span class="p">][</span><span class="s2">&quot;city&quot;</span><span class="p">]</span>
            <span class="n">zip_state</span> <span class="o">=</span> <span class="n">zip_cache</span><span class="p">[</span><span class="n">zipcode</span><span class="p">][</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>

            <span class="k">return</span> <span class="p">(</span><span class="n">zip_city</span><span class="p">,</span> <span class="n">zip_state</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="n">SearchEngine</span><span class="p">()</span>
            <span class="n">zipcode_obj</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">by_zipcode</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">zipcode</span><span class="p">))</span>
            <span class="c1"># zip_cache[zipcode] = zipcode</span>

            <span class="n">zip_city</span> <span class="o">=</span> <span class="n">zipcode_obj</span><span class="o">.</span><span class="n">major_city</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">zip_state</span> <span class="o">=</span> <span class="n">zipcode_obj</span><span class="o">.</span><span class="n">state</span>

            <span class="n">zip_citystate</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="n">zip_city</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">zip_state</span><span class="p">}</span>
            <span class="n">zip_cache</span><span class="p">[</span><span class="n">zipcode</span><span class="p">]</span> <span class="o">=</span> <span class="n">zip_citystate</span>

            <span class="k">return</span> <span class="p">(</span><span class="n">zip_city</span><span class="p">,</span> <span class="n">zip_state</span><span class="p">)</span>

    <span class="c1"># Handle cases where zip code is null or not a number</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.cleaning.cleaning_functions.predict_org" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict_org</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>

<a href="#chainlink.cleaning.cleaning_functions.predict_org" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Given a string, predict whether or not the string is an organization name.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An entity name.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>int</code></td>            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>1 if the name is an organization, 0 if the name is an individual.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/cleaning/cleaning_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict_org</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a string, predict whether or not the string is an organization name.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): An entity name.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: 1 if the name is an organization, 0 if the name is an individual.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">individual_names</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;CURRENT OWNER|TAX PAYER OF|OWNER OF RECORD|PROPERTY OWNER&quot;</span><span class="p">,</span>
        <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;0-1&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">ABB_PATTERNS</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">WORD_PATTERNS</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">EOL_PATTERNS</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="c1"># Doing this because GX PROPERTY OWNER LLC exists</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">individual_names</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.cleaning.cleaning_functions.remove_initial_I" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">remove_initial_I</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span></code>

<a href="#chainlink.cleaning.cleaning_functions.remove_initial_I" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Remove the "I" or I" present for some names in corporation
and LLC data where name was incorrectly entered in the
style of "I, John Smith" instead of just "John Smith"</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/cleaning/cleaning_functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_initial_I</span><span class="p">(</span><span class="n">raw</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove the &quot;I&quot; or I&quot; present for some names in corporation</span>
<span class="sd">    and LLC data where name was incorrectly entered in the</span>
<span class="sd">    style of &quot;I, John Smith&quot; instead of just &quot;John Smith&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">raw</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&quot;I&quot;&#39;</span><span class="p">:</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">raw</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;I&quot;&#39;</span><span class="p">:</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">raw</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="chainlink.link" class="doc doc-heading">
            <code>link</code>


<a href="#chainlink.link" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="chainlink.link.link_generic" class="doc doc-heading">
            <code>link_generic</code>


<a href="#chainlink.link.link_generic" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="chainlink.link.link_generic.create_across_links" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_across_links</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">new_schema</span><span class="p">,</span> <span class="n">existing_schema</span><span class="p">,</span> <span class="n">link_exclusions</span><span class="p">)</span></code>

<a href="#chainlink.link.link_generic.create_across_links" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>For each entity in the existing_db list, create links between the new entity
and the existing entity.</p>


<details class="for-old_entity-in-existing_db" open>
  <summary>for old_entity in existing_db</summary>
  <p>-find all the name links old_entity.name to new_entity.name, etc.
-find all the address links old_entity.address to new_entity.address, etc.
    -match by raw address string
    -match by clean street string
    -if street id matches, match by unit
    -match street name and number if zipcode matches</p>
</details>        <p>Returns: None</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/link_generic.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_across_links</span><span class="p">(</span><span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">new_schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">existing_schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">link_exclusions</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each entity in the existing_db list, create links between the new entity</span>
<span class="sd">    and the existing entity.</span>

<span class="sd">    for old_entity in existing_db:</span>
<span class="sd">        -find all the name links old_entity.name to new_entity.name, etc.</span>
<span class="sd">        -find all the address links old_entity.address to new_entity.address, etc.</span>
<span class="sd">            -match by raw address string</span>
<span class="sd">            -match by clean street string</span>
<span class="sd">            -if street id matches, match by unit</span>
<span class="sd">            -match street name and number if zipcode matches</span>

<span class="sd">    Returns: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new_entity</span> <span class="o">=</span> <span class="n">new_schema</span><span class="p">[</span><span class="s2">&quot;schema_name&quot;</span><span class="p">]</span>

    <span class="n">new_entity_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_entity_addresses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># gather all the name and address columns for the new entity</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">new_schema</span><span class="p">[</span><span class="s2">&quot;tables&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">name_col</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;name_cols&quot;</span><span class="p">]:</span>
            <span class="n">new_entity_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">],</span> <span class="n">name_col</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">address_col</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;address_cols&quot;</span><span class="p">]:</span>
            <span class="n">new_entity_addresses</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">],</span> <span class="n">address_col</span><span class="p">))</span>

    <span class="c1"># create name and address matches for each existing entity and new entity</span>
    <span class="n">existing_entity</span> <span class="o">=</span> <span class="n">existing_schema</span><span class="p">[</span><span class="s2">&quot;schema_name&quot;</span><span class="p">]</span>

    <span class="n">existing_entity_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">existing_entity_addresses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># gather all the name and address columns for this existing entity</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">existing_schema</span><span class="p">[</span><span class="s2">&quot;tables&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">name_col</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;name_cols&quot;</span><span class="p">]:</span>
            <span class="n">existing_entity_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                <span class="n">table</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">],</span>
                <span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">],</span>
                <span class="n">name_col</span><span class="p">,</span>
            <span class="p">))</span>
        <span class="k">for</span> <span class="n">address_col</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;address_cols&quot;</span><span class="p">]:</span>
            <span class="n">existing_entity_addresses</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                <span class="n">table</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">],</span>
                <span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">],</span>
                <span class="n">address_col</span><span class="p">,</span>
            <span class="p">))</span>
    <span class="c1"># generate name match combos</span>
    <span class="n">name_combos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">new_entity_names</span><span class="p">,</span> <span class="n">existing_entity_names</span><span class="p">))</span>

    <span class="c1"># need to add in across table within entity combos</span>

    <span class="k">for</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span> <span class="ow">in</span> <span class="n">name_combos</span><span class="p">:</span>
        <span class="n">left_table</span><span class="p">,</span> <span class="n">left_ent_id</span><span class="p">,</span> <span class="n">left_name</span> <span class="o">=</span> <span class="n">new</span>
        <span class="n">right_table</span><span class="p">,</span> <span class="n">right_ent_id</span><span class="p">,</span> <span class="n">right_name</span> <span class="o">=</span> <span class="n">old</span>

        <span class="n">execute_match</span><span class="p">(</span>
            <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
            <span class="n">left_entity</span><span class="o">=</span><span class="n">new_entity</span><span class="p">,</span>
            <span class="n">left_table</span><span class="o">=</span><span class="n">left_table</span><span class="p">,</span>
            <span class="n">left_matching_col</span><span class="o">=</span><span class="n">left_name</span><span class="p">,</span>
            <span class="n">left_ent_id</span><span class="o">=</span><span class="n">left_ent_id</span><span class="p">,</span>
            <span class="n">match_type</span><span class="o">=</span><span class="s2">&quot;name_match&quot;</span><span class="p">,</span>
            <span class="n">left_matching_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_name</span><span class="si">}</span><span class="s2">_name_id&quot;</span><span class="p">,</span>
            <span class="n">right_entity</span><span class="o">=</span><span class="n">existing_entity</span><span class="p">,</span>
            <span class="n">right_table</span><span class="o">=</span><span class="n">right_table</span><span class="p">,</span>
            <span class="n">right_matching_col</span><span class="o">=</span><span class="n">right_name</span><span class="p">,</span>
            <span class="n">right_ent_id</span><span class="o">=</span><span class="n">right_ent_id</span><span class="p">,</span>
            <span class="n">right_matching_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_name</span><span class="si">}</span><span class="s2">_name_id&quot;</span><span class="p">,</span>
            <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># generate address match combos</span>
    <span class="n">address_combos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">new_entity_addresses</span><span class="p">,</span> <span class="n">existing_entity_addresses</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span> <span class="ow">in</span> <span class="n">address_combos</span><span class="p">:</span>
        <span class="n">left_table</span><span class="p">,</span> <span class="n">left_ent_id</span><span class="p">,</span> <span class="n">left_address</span> <span class="o">=</span> <span class="n">new</span>
        <span class="n">right_table</span><span class="p">,</span> <span class="n">right_ent_id</span><span class="p">,</span> <span class="n">right_address</span> <span class="o">=</span> <span class="n">old</span>

        <span class="n">execute_match_address</span><span class="p">(</span>
            <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
            <span class="n">left_entity</span><span class="o">=</span><span class="n">new_entity</span><span class="p">,</span>
            <span class="n">left_table</span><span class="o">=</span><span class="n">left_table</span><span class="p">,</span>
            <span class="n">left_address</span><span class="o">=</span><span class="n">left_address</span><span class="p">,</span>
            <span class="n">left_ent_id</span><span class="o">=</span><span class="n">left_ent_id</span><span class="p">,</span>
            <span class="n">right_entity</span><span class="o">=</span><span class="n">existing_entity</span><span class="p">,</span>
            <span class="n">right_table</span><span class="o">=</span><span class="n">right_table</span><span class="p">,</span>
            <span class="n">right_address</span><span class="o">=</span><span class="n">right_address</span><span class="p">,</span>
            <span class="n">right_ent_id</span><span class="o">=</span><span class="n">right_ent_id</span><span class="p">,</span>
            <span class="n">skip_address</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.link.link_generic.create_tfidf_across_links" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_tfidf_across_links</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">new_schema</span><span class="p">,</span> <span class="n">existing_schema</span><span class="p">,</span> <span class="n">link_exclusions</span><span class="p">)</span></code>

<a href="#chainlink.link.link_generic.create_tfidf_across_links" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>create all fuzzy links across new entity and existing entity</p>
<p>Returns: None</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/link_generic.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_tfidf_across_links</span><span class="p">(</span>
    <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">new_schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">existing_schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">link_exclusions</span><span class="p">:</span> <span class="nb">list</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create all fuzzy links across new entity and existing entity</span>

<span class="sd">    Returns: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_entity</span> <span class="o">=</span> <span class="n">new_schema</span><span class="p">[</span><span class="s2">&quot;schema_name&quot;</span><span class="p">]</span>

    <span class="c1"># gather all the name columns for the new entity</span>
    <span class="n">new_entity_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_entity_addresses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">new_schema</span><span class="p">[</span><span class="s2">&quot;tables&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">name_col</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;name_cols&quot;</span><span class="p">]:</span>
            <span class="n">new_entity_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">],</span> <span class="n">name_col</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">address_col</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;address_cols&quot;</span><span class="p">]:</span>
            <span class="n">new_entity_addresses</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">],</span> <span class="n">address_col</span><span class="p">))</span>

    <span class="c1"># go through all the existing entities / schemas</span>

    <span class="n">existing_entity</span> <span class="o">=</span> <span class="n">existing_schema</span><span class="p">[</span><span class="s2">&quot;schema_name&quot;</span><span class="p">]</span>

    <span class="n">existing_entity_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">existing_entity_addresses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># gather all the name and address columns for this existing entity</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">existing_schema</span><span class="p">[</span><span class="s2">&quot;tables&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">name_col</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;name_cols&quot;</span><span class="p">]:</span>
            <span class="n">existing_entity_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                <span class="n">table</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">],</span>
                <span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">],</span>
                <span class="n">name_col</span><span class="p">,</span>
            <span class="p">))</span>
        <span class="k">for</span> <span class="n">address_col</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;address_cols&quot;</span><span class="p">]:</span>
            <span class="n">existing_entity_addresses</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                <span class="n">table</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">],</span>
                <span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">],</span>
                <span class="n">address_col</span><span class="p">,</span>
            <span class="p">))</span>
    <span class="c1"># generate name match combos</span>

    <span class="n">name_combos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">new_entity_names</span><span class="p">,</span> <span class="n">existing_entity_names</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span> <span class="ow">in</span> <span class="n">name_combos</span><span class="p">:</span>
        <span class="n">left_table</span><span class="p">,</span> <span class="n">left_ent_id</span><span class="p">,</span> <span class="n">left_name</span> <span class="o">=</span> <span class="n">new</span>
        <span class="n">right_table</span><span class="p">,</span> <span class="n">right_ent_id</span><span class="p">,</span> <span class="n">right_name</span> <span class="o">=</span> <span class="n">old</span>

        <span class="n">execute_fuzzy_link</span><span class="p">(</span>
            <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
            <span class="n">left_entity</span><span class="o">=</span><span class="n">new_entity</span><span class="p">,</span>
            <span class="n">left_table</span><span class="o">=</span><span class="n">left_table</span><span class="p">,</span>
            <span class="n">left_ent_id</span><span class="o">=</span><span class="n">left_ent_id</span><span class="p">,</span>
            <span class="n">left_name_col</span><span class="o">=</span><span class="n">left_name</span><span class="p">,</span>
            <span class="n">right_entity</span><span class="o">=</span><span class="n">existing_entity</span><span class="p">,</span>
            <span class="n">right_table</span><span class="o">=</span><span class="n">right_table</span><span class="p">,</span>
            <span class="n">right_ent_id</span><span class="o">=</span><span class="n">right_ent_id</span><span class="p">,</span>
            <span class="n">right_name_col</span><span class="o">=</span><span class="n">right_name</span><span class="p">,</span>
            <span class="n">tfidf_table</span><span class="o">=</span><span class="s2">&quot;entity.name_similarity&quot;</span><span class="p">,</span>
            <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># generate address match combos</span>
    <span class="n">address_combos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">new_entity_addresses</span><span class="p">,</span> <span class="n">existing_entity_addresses</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span> <span class="ow">in</span> <span class="n">address_combos</span><span class="p">:</span>
        <span class="n">left_table</span><span class="p">,</span> <span class="n">left_ent_id</span><span class="p">,</span> <span class="n">left_address</span> <span class="o">=</span> <span class="n">new</span>
        <span class="n">right_table</span><span class="p">,</span> <span class="n">right_ent_id</span><span class="p">,</span> <span class="n">right_address</span> <span class="o">=</span> <span class="n">old</span>

        <span class="n">execute_address_fuzzy_link</span><span class="p">(</span>
            <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
            <span class="n">left_entity</span><span class="o">=</span><span class="n">new_entity</span><span class="p">,</span>
            <span class="n">left_table</span><span class="o">=</span><span class="n">left_table</span><span class="p">,</span>
            <span class="n">left_ent_id</span><span class="o">=</span><span class="n">left_ent_id</span><span class="p">,</span>
            <span class="n">left_address_col</span><span class="o">=</span><span class="n">left_address</span><span class="p">,</span>
            <span class="n">right_entity</span><span class="o">=</span><span class="n">existing_entity</span><span class="p">,</span>
            <span class="n">right_table</span><span class="o">=</span><span class="n">right_table</span><span class="p">,</span>
            <span class="n">right_ent_id</span><span class="o">=</span><span class="n">right_ent_id</span><span class="p">,</span>
            <span class="n">right_address_col</span><span class="o">=</span><span class="n">right_address</span><span class="p">,</span>
            <span class="n">tfidf_table</span><span class="o">=</span><span class="s2">&quot;entity.street_name_similarity&quot;</span><span class="p">,</span>
            <span class="n">skip_address</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.link.link_generic.create_tfidf_within_links" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_tfidf_within_links</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">schema_config</span><span class="p">,</span> <span class="n">link_exclusions</span><span class="p">)</span></code>

<a href="#chainlink.link.link_generic.create_tfidf_within_links" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>create tfidf links within entity</p>
<p>Returns: None</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/link_generic.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_tfidf_within_links</span><span class="p">(</span><span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">schema_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">link_exclusions</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create tfidf links within entity</span>

<span class="sd">    Returns: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new_entity</span> <span class="o">=</span> <span class="n">schema_config</span><span class="p">[</span><span class="s2">&quot;schema_name&quot;</span><span class="p">]</span>
    <span class="n">within_entity_across_tables_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">within_entity_across_tables_addresses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># create fuzzy links</span>
    <span class="c1"># generate combos, need all within tables</span>

    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">schema_config</span><span class="p">[</span><span class="s2">&quot;tables&quot;</span><span class="p">]:</span>
        <span class="c1"># generate name matches combos</span>
        <span class="n">name_combos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;name_cols&quot;</span><span class="p">],</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">left_name</span><span class="p">,</span> <span class="n">right_name</span> <span class="ow">in</span> <span class="n">name_combos</span><span class="p">:</span>
            <span class="n">execute_fuzzy_link</span><span class="p">(</span>
                <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
                <span class="n">left_entity</span><span class="o">=</span><span class="n">new_entity</span><span class="p">,</span>
                <span class="n">left_table</span><span class="o">=</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">],</span>
                <span class="n">left_ent_id</span><span class="o">=</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">],</span>
                <span class="n">left_name_col</span><span class="o">=</span><span class="n">left_name</span><span class="p">,</span>
                <span class="n">right_entity</span><span class="o">=</span><span class="n">new_entity</span><span class="p">,</span>
                <span class="n">right_table</span><span class="o">=</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">],</span>
                <span class="n">right_ent_id</span><span class="o">=</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">],</span>
                <span class="n">right_name_col</span><span class="o">=</span><span class="n">right_name</span><span class="p">,</span>
                <span class="n">tfidf_table</span><span class="o">=</span><span class="s2">&quot;entity.name_similarity&quot;</span><span class="p">,</span>
                <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">address_combos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;address_cols&quot;</span><span class="p">],</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">left_address</span><span class="p">,</span> <span class="n">right_address</span> <span class="ow">in</span> <span class="n">address_combos</span><span class="p">:</span>
            <span class="n">execute_address_fuzzy_link</span><span class="p">(</span>
                <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
                <span class="n">left_entity</span><span class="o">=</span><span class="n">new_entity</span><span class="p">,</span>
                <span class="n">left_table</span><span class="o">=</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">],</span>
                <span class="n">left_ent_id</span><span class="o">=</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">],</span>
                <span class="n">left_address_col</span><span class="o">=</span><span class="n">left_address</span><span class="p">,</span>
                <span class="n">right_entity</span><span class="o">=</span><span class="n">new_entity</span><span class="p">,</span>
                <span class="n">right_table</span><span class="o">=</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">],</span>
                <span class="n">right_ent_id</span><span class="o">=</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">],</span>
                <span class="n">right_address_col</span><span class="o">=</span><span class="n">right_address</span><span class="p">,</span>
                <span class="n">tfidf_table</span><span class="o">=</span><span class="s2">&quot;entity.street_name_similarity&quot;</span><span class="p">,</span>
                <span class="n">skip_address</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># for across tables within entity</span>
        <span class="n">within_entity_across_tables_names</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
            <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;name_cols&quot;</span><span class="p">]</span>
        <span class="p">])</span>
        <span class="n">within_entity_across_tables_addresses</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
            <span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;address_cols&quot;</span><span class="p">]</span>
        <span class="p">])</span>

    <span class="c1"># generate combos, across tables within entity</span>
    <span class="n">across_name_combos</span><span class="p">,</span> <span class="n">across_address_combos</span> <span class="o">=</span> <span class="n">generate_combos_within_across_tables</span><span class="p">(</span>
        <span class="n">within_entity_across_tables_names</span><span class="p">,</span> <span class="n">within_entity_across_tables_addresses</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="n">across_name_combos</span><span class="p">:</span>
        <span class="n">left_name</span><span class="p">,</span> <span class="n">left_table</span><span class="p">,</span> <span class="n">left_ent_id</span> <span class="o">=</span> <span class="n">left</span>
        <span class="n">right_name</span><span class="p">,</span> <span class="n">right_table</span><span class="p">,</span> <span class="n">right_ent_id</span> <span class="o">=</span> <span class="n">right</span>

        <span class="n">execute_fuzzy_link</span><span class="p">(</span>
            <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
            <span class="n">left_entity</span><span class="o">=</span><span class="n">new_entity</span><span class="p">,</span>
            <span class="n">left_table</span><span class="o">=</span><span class="n">left_table</span><span class="p">,</span>
            <span class="n">left_ent_id</span><span class="o">=</span><span class="n">left_ent_id</span><span class="p">,</span>
            <span class="n">left_name_col</span><span class="o">=</span><span class="n">left_name</span><span class="p">,</span>
            <span class="n">right_entity</span><span class="o">=</span><span class="n">new_entity</span><span class="p">,</span>
            <span class="n">right_table</span><span class="o">=</span><span class="n">right_table</span><span class="p">,</span>
            <span class="n">right_ent_id</span><span class="o">=</span><span class="n">right_ent_id</span><span class="p">,</span>
            <span class="n">right_name_col</span><span class="o">=</span><span class="n">right_name</span><span class="p">,</span>
            <span class="n">tfidf_table</span><span class="o">=</span><span class="s2">&quot;entity.name_similarity&quot;</span><span class="p">,</span>
            <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="n">across_address_combos</span><span class="p">:</span>
        <span class="n">left_address</span><span class="p">,</span> <span class="n">left_table</span><span class="p">,</span> <span class="n">left_ent_id</span> <span class="o">=</span> <span class="n">left</span>
        <span class="n">right_address</span><span class="p">,</span> <span class="n">right_table</span><span class="p">,</span> <span class="n">right_ent_id</span> <span class="o">=</span> <span class="n">right</span>
        <span class="n">execute_address_fuzzy_link</span><span class="p">(</span>
            <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
            <span class="n">left_entity</span><span class="o">=</span><span class="n">new_entity</span><span class="p">,</span>
            <span class="n">left_table</span><span class="o">=</span><span class="n">left_table</span><span class="p">,</span>
            <span class="n">left_ent_id</span><span class="o">=</span><span class="n">left_ent_id</span><span class="p">,</span>
            <span class="n">left_address_col</span><span class="o">=</span><span class="n">left_address</span><span class="p">,</span>
            <span class="n">right_entity</span><span class="o">=</span><span class="n">new_entity</span><span class="p">,</span>
            <span class="n">right_table</span><span class="o">=</span><span class="n">right_table</span><span class="p">,</span>
            <span class="n">right_ent_id</span><span class="o">=</span><span class="n">right_ent_id</span><span class="p">,</span>
            <span class="n">right_address_col</span><span class="o">=</span><span class="n">right_address</span><span class="p">,</span>
            <span class="n">tfidf_table</span><span class="o">=</span><span class="s2">&quot;entity.street_name_similarity&quot;</span><span class="p">,</span>
            <span class="n">skip_address</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.link.link_generic.create_within_links" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_within_links</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">schema_config</span><span class="p">,</span> <span class="n">link_exclusions</span><span class="p">)</span></code>

<a href="#chainlink.link.link_generic.create_within_links" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Creates exact string matches on name and address fields for entity and
entity.</p>


<details class="for-each-file-find-the-links-with-the-file" open>
  <summary>For each file find the links with the file</summary>
  <p>-find all the name links includes name1 to name1, name1 to name2, etc.
-find all the address links includes address1 to address1, address1 to address2, etc.
    -match by raw address string
    -match by clean street string
    -if street id matches, match by unit
    -match street name and number if zipcode matches
-find all name and address links across tables within the entity</p>
</details>        <p>Returns: None</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/link_generic.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_within_links</span><span class="p">(</span><span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">schema_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">link_exclusions</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates exact string matches on name and address fields for entity and</span>
<span class="sd">    entity.</span>

<span class="sd">    For each file find the links with the file:</span>
<span class="sd">        -find all the name links includes name1 to name1, name1 to name2, etc.</span>
<span class="sd">        -find all the address links includes address1 to address1, address1 to address2, etc.</span>
<span class="sd">            -match by raw address string</span>
<span class="sd">            -match by clean street string</span>
<span class="sd">            -if street id matches, match by unit</span>
<span class="sd">            -match street name and number if zipcode matches</span>
<span class="sd">        -find all name and address links across tables within the entity</span>

<span class="sd">    Returns: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">entity</span> <span class="o">=</span> <span class="n">schema_config</span><span class="p">[</span><span class="s2">&quot;schema_name&quot;</span><span class="p">]</span>

    <span class="n">within_entity_across_tables_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">within_entity_across_tables_addresses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># within each table</span>
    <span class="k">for</span> <span class="n">table_config</span> <span class="ow">in</span> <span class="n">schema_config</span><span class="p">[</span><span class="s2">&quot;tables&quot;</span><span class="p">]:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">table_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name_cols&quot;</span><span class="p">):</span>
            <span class="c1"># generate name matches combos</span>
            <span class="n">name_combos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;name_cols&quot;</span><span class="p">],</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">left_name</span><span class="p">,</span> <span class="n">right_name</span> <span class="ow">in</span> <span class="n">name_combos</span><span class="p">:</span>
                <span class="n">execute_match</span><span class="p">(</span>
                    <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
                    <span class="n">match_type</span><span class="o">=</span><span class="s2">&quot;name_match&quot;</span><span class="p">,</span>
                    <span class="n">left_entity</span><span class="o">=</span><span class="n">entity</span><span class="p">,</span>
                    <span class="n">left_table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
                    <span class="n">left_matching_col</span><span class="o">=</span><span class="n">left_name</span><span class="p">,</span>
                    <span class="n">left_matching_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_name</span><span class="si">}</span><span class="s2">_name_id&quot;</span><span class="p">,</span>
                    <span class="n">left_ent_id</span><span class="o">=</span><span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">],</span>
                    <span class="n">right_entity</span><span class="o">=</span><span class="n">entity</span><span class="p">,</span>
                    <span class="n">right_table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
                    <span class="n">right_matching_col</span><span class="o">=</span><span class="n">right_name</span><span class="p">,</span>
                    <span class="n">right_ent_id</span><span class="o">=</span><span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">],</span>
                    <span class="n">right_matching_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_name</span><span class="si">}</span><span class="s2">_name_id&quot;</span><span class="p">,</span>
                    <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">table_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;address_cols&quot;</span><span class="p">):</span>
            <span class="c1"># address within</span>
            <span class="n">address_combos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;address_cols&quot;</span><span class="p">],</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">left_address</span><span class="p">,</span> <span class="n">right_address</span> <span class="ow">in</span> <span class="n">address_combos</span><span class="p">:</span>
                <span class="n">execute_match_address</span><span class="p">(</span>
                    <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
                    <span class="n">left_entity</span><span class="o">=</span><span class="n">entity</span><span class="p">,</span>
                    <span class="n">left_table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
                    <span class="n">left_address</span><span class="o">=</span><span class="n">left_address</span><span class="p">,</span>
                    <span class="n">left_ent_id</span><span class="o">=</span><span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">],</span>
                    <span class="n">right_entity</span><span class="o">=</span><span class="n">entity</span><span class="p">,</span>
                    <span class="n">right_table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
                    <span class="n">right_address</span><span class="o">=</span><span class="n">right_address</span><span class="p">,</span>
                    <span class="n">right_ent_id</span><span class="o">=</span><span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">],</span>
                    <span class="n">skip_address</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># for across tables</span>
        <span class="k">if</span> <span class="n">table_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name_cols&quot;</span><span class="p">):</span>
            <span class="n">within_entity_across_tables_names</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;name_cols&quot;</span><span class="p">]</span>
            <span class="p">])</span>
        <span class="k">if</span> <span class="n">table_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;address_cols&quot;</span><span class="p">):</span>
            <span class="n">within_entity_across_tables_addresses</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;address_cols&quot;</span><span class="p">]</span>
            <span class="p">])</span>

    <span class="c1"># generate combos across tables</span>
    <span class="k">if</span> <span class="n">within_entity_across_tables_names</span> <span class="ow">or</span> <span class="n">within_entity_across_tables_addresses</span><span class="p">:</span>
        <span class="n">across_name_combos</span><span class="p">,</span> <span class="n">across_address_combos</span> <span class="o">=</span> <span class="n">generate_combos_within_across_tables</span><span class="p">(</span>
            <span class="n">within_entity_across_tables_names</span><span class="p">,</span> <span class="n">within_entity_across_tables_addresses</span>
        <span class="p">)</span>

    <span class="c1"># across files for name</span>
    <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="n">across_name_combos</span><span class="p">:</span>
        <span class="n">left_name</span><span class="p">,</span> <span class="n">left_table</span><span class="p">,</span> <span class="n">left_ent_id</span> <span class="o">=</span> <span class="n">left</span>
        <span class="n">right_name</span><span class="p">,</span> <span class="n">right_table</span><span class="p">,</span> <span class="n">right_ent_id</span> <span class="o">=</span> <span class="n">right</span>

        <span class="n">execute_match</span><span class="p">(</span>
            <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
            <span class="n">match_type</span><span class="o">=</span><span class="s2">&quot;name_match&quot;</span><span class="p">,</span>
            <span class="n">left_entity</span><span class="o">=</span><span class="n">entity</span><span class="p">,</span>
            <span class="n">left_table</span><span class="o">=</span><span class="n">left_table</span><span class="p">,</span>
            <span class="n">left_matching_col</span><span class="o">=</span><span class="n">left_name</span><span class="p">,</span>
            <span class="n">left_ent_id</span><span class="o">=</span><span class="n">left_ent_id</span><span class="p">,</span>
            <span class="n">left_matching_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_name</span><span class="si">}</span><span class="s2">_name_id&quot;</span><span class="p">,</span>
            <span class="n">right_entity</span><span class="o">=</span><span class="n">entity</span><span class="p">,</span>
            <span class="n">right_table</span><span class="o">=</span><span class="n">right_table</span><span class="p">,</span>
            <span class="n">right_matching_col</span><span class="o">=</span><span class="n">right_name</span><span class="p">,</span>
            <span class="n">right_ent_id</span><span class="o">=</span><span class="n">right_ent_id</span><span class="p">,</span>
            <span class="n">right_matching_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_name</span><span class="si">}</span><span class="s2">_name_id&quot;</span><span class="p">,</span>
            <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># across files for address</span>
    <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="n">across_address_combos</span><span class="p">:</span>
        <span class="n">left_address</span><span class="p">,</span> <span class="n">left_table</span><span class="p">,</span> <span class="n">left_ent_id</span> <span class="o">=</span> <span class="n">left</span>
        <span class="n">right_address</span><span class="p">,</span> <span class="n">right_table</span><span class="p">,</span> <span class="n">right_ent_id</span> <span class="o">=</span> <span class="n">right</span>

        <span class="n">execute_match_address</span><span class="p">(</span>
            <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
            <span class="n">left_entity</span><span class="o">=</span><span class="n">entity</span><span class="p">,</span>
            <span class="n">left_table</span><span class="o">=</span><span class="n">left_table</span><span class="p">,</span>
            <span class="n">left_address</span><span class="o">=</span><span class="n">left_address</span><span class="p">,</span>
            <span class="n">left_ent_id</span><span class="o">=</span><span class="n">left_ent_id</span><span class="p">,</span>
            <span class="n">right_entity</span><span class="o">=</span><span class="n">entity</span><span class="p">,</span>
            <span class="n">right_table</span><span class="o">=</span><span class="n">right_table</span><span class="p">,</span>
            <span class="n">right_address</span><span class="o">=</span><span class="n">right_address</span><span class="p">,</span>
            <span class="n">right_ent_id</span><span class="o">=</span><span class="n">right_ent_id</span><span class="p">,</span>
            <span class="n">skip_address</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="chainlink.link.link_utils" class="doc doc-heading">
            <code>link_utils</code>


<a href="#chainlink.link.link_utils" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="chainlink.link.link_utils.execute_address_fuzzy_link" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute_address_fuzzy_link</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">left_entity</span><span class="p">,</span> <span class="n">left_table</span><span class="p">,</span> <span class="n">left_ent_id</span><span class="p">,</span> <span class="n">left_address_col</span><span class="p">,</span> <span class="n">right_entity</span><span class="p">,</span> <span class="n">right_table</span><span class="p">,</span> <span class="n">right_ent_id</span><span class="p">,</span> <span class="n">right_address_col</span><span class="p">,</span> <span class="n">tfidf_table</span><span class="o">=</span><span class="s1">&#39;link.tfidf_staging&#39;</span><span class="p">,</span> <span class="n">skip_address</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">link_exclusions</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#chainlink.link.link_utils.execute_address_fuzzy_link" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>fuzzy address matching</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/link_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute_address_fuzzy_link</span><span class="p">(</span>
    <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">left_entity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_ent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_address_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_entity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_ent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_address_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tfidf_table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;link.tfidf_staging&quot;</span><span class="p">,</span>
    <span class="n">skip_address</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">link_exclusions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    fuzzy address matching</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">link_exclusions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">link_exclusions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">link_table</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;link.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># align the names of the match columns</span>
    <span class="n">left_side</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_table</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">right_side</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_table</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">left_entity</span> <span class="o">!=</span> <span class="n">right_entity</span><span class="p">:</span>
        <span class="n">match_name_stem</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_side</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">left_side</span> <span class="o">&lt;</span> <span class="n">right_side</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_side</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">match_name_stem</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_side</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">same_condition</span> <span class="o">=</span> <span class="s2">&quot;TRUE&quot;</span>

    <span class="k">if</span> <span class="n">left_ent_id</span> <span class="o">==</span> <span class="n">right_ent_id</span> <span class="ow">and</span> <span class="n">left_entity</span> <span class="o">==</span> <span class="n">right_entity</span><span class="p">:</span>
        <span class="n">left_ent_id_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_ent_id</span><span class="si">}</span><span class="s2">_1&quot;</span>
        <span class="n">right_ent_id_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_ent_id</span><span class="si">}</span><span class="s2">_2&quot;</span>
        <span class="n">left_unit_num_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">_unit_number_1&quot;</span>
        <span class="n">right_unit_num_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">_unit_number_2&quot;</span>
        <span class="n">left_address_num_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">_address_number_1&quot;</span>
        <span class="n">right_address_num_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">_address_number_2&quot;</span>
        <span class="n">left_postal_code_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">_postal_code_1&quot;</span>
        <span class="n">right_postal_code_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">_postal_code_2&quot;</span>
        <span class="n">left_directional_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">_street_pre_directional_1&quot;</span>
        <span class="n">right_directional_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">_street_pre_directional_2&quot;</span>
        <span class="c1"># if same id, want to remove dupes</span>
        <span class="n">same_condition</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_rename</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_rename</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">left_ent_id_rename</span> <span class="o">=</span> <span class="n">left_ent_id</span>
        <span class="n">right_ent_id_rename</span> <span class="o">=</span> <span class="n">right_ent_id</span>
        <span class="n">left_unit_num_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">_unit_number&quot;</span>
        <span class="n">right_unit_num_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">_unit_number&quot;</span>
        <span class="n">left_address_num_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">_address_number&quot;</span>
        <span class="n">right_address_num_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">_address_number&quot;</span>
        <span class="n">left_postal_code_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">_postal_code&quot;</span>
        <span class="n">right_postal_code_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">_postal_code&quot;</span>
        <span class="n">left_directional_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">_street_pre_directional&quot;</span>
        <span class="n">right_directional_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">_street_pre_directional&quot;</span>

    <span class="k">if</span> <span class="n">skip_address</span><span class="p">:</span>
        <span class="n">address_condition</span> <span class="o">=</span> <span class="s2">&quot; != 1&quot;</span>
        <span class="n">left_address_condition</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">_skip </span><span class="si">{</span><span class="n">address_condition</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">right_address_condition</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">_skip </span><span class="si">{</span><span class="n">address_condition</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">left_address_condition</span> <span class="o">=</span> <span class="s2">&quot;TRUE&quot;</span>
        <span class="n">right_address_condition</span> <span class="o">=</span> <span class="s2">&quot;TRUE&quot;</span>

    <span class="n">match_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">match_name_stem</span><span class="si">}</span><span class="s2">_street_fuzzy_match&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">match_name_stem</span><span class="si">}</span><span class="s2">_unit_fuzzy_match&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_address_num_rename</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_address_num_rename</span><span class="si">}</span><span class="s2"> AND</span>
<span class="s2">        </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_postal_code_rename</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_postal_code_rename</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_address_num_rename</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_address_num_rename</span><span class="si">}</span><span class="s2"> AND</span>
<span class="s2">        </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_postal_code_rename</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_postal_code_rename</span><span class="si">}</span><span class="s2"> AND</span>
<span class="s2">        CAST(</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_unit_num_rename</span><span class="si">}</span><span class="s2"> AS VARCHAR) = CAST(</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_unit_num_rename</span><span class="si">}</span><span class="s2"> AS VARCHAR)</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">match_name</span><span class="p">,</span> <span class="n">condition</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">match_names</span><span class="p">,</span> <span class="n">conditions</span><span class="p">):</span>
        <span class="c1"># check link exclusion</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">exclusion</span> <span class="ow">in</span> <span class="n">match_name</span> <span class="k">for</span> <span class="n">exclusion</span> <span class="ow">in</span> <span class="n">link_exclusions</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE OR REPLACE TABLE </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2"> AS</span>

<span class="s2">        WITH tfidf_matches AS (</span>
<span class="s2">            SELECT id_a,</span>
<span class="s2">                id_b,</span>
<span class="s2">                similarity as </span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span>
<span class="s2">            FROM </span><span class="si">{</span><span class="n">tfidf_table</span><span class="si">}</span>
<span class="s2">        ),</span>

<span class="s2">        left_source AS (</span>
<span class="s2">            SELECT </span><span class="si">{</span><span class="n">left_ent_id</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">_street_name_id,</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">_unit_number as </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_unit_num_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">_street_pre_directional as </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_directional_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">_address_number as </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_address_num_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">_postal_code as </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_postal_code_rename</span><span class="si">}</span>
<span class="s2">            FROM </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">left_table</span><span class="si">}</span>
<span class="s2">            WHERE </span><span class="si">{</span><span class="n">left_address_condition</span><span class="si">}</span>
<span class="s2">        ),</span>

<span class="s2">        right_source AS (</span>
<span class="s2">            SELECT </span><span class="si">{</span><span class="n">right_ent_id</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">_street_name_id,</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">_unit_number as </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_unit_num_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">_street_pre_directional as </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_directional_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">_address_number as </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_address_num_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">_postal_code as </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_postal_code_rename</span><span class="si">}</span>
<span class="s2">            FROM </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">right_table</span><span class="si">}</span>
<span class="s2">            WHERE </span><span class="si">{</span><span class="n">right_address_condition</span><span class="si">}</span>
<span class="s2">        ),</span>

<span class="s2">        fuzzy_match_1 AS (</span>
<span class="s2">            SELECT l.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                l.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_unit_num_rename</span><span class="si">}</span><span class="s2">, l.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_address_num_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                l.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_postal_code_rename</span><span class="si">}</span><span class="s2">, l.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_directional_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                r.</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                r.</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_unit_num_rename</span><span class="si">}</span><span class="s2">, r.</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_address_num_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                r.</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_postal_code_rename</span><span class="si">}</span><span class="s2">, r.</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_directional_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                m.</span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span>
<span class="s2">            FROM   tfidf_matches as m</span>
<span class="s2">            INNER JOIN left_source as l</span>
<span class="s2">                ON m.id_a = l.</span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">_street_name_id</span>
<span class="s2">            INNER JOIN right_source as r</span>
<span class="s2">                ON m.id_b = r.</span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">_street_name_id</span>
<span class="s2">        ),</span>

<span class="s2">        fuzzy_match_2 AS (</span>
<span class="s2">            SELECT l.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                l.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_unit_num_rename</span><span class="si">}</span><span class="s2">, l.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_address_num_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                l.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_postal_code_rename</span><span class="si">}</span><span class="s2">, l.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_directional_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                r.</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                r.</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_unit_num_rename</span><span class="si">}</span><span class="s2">, r.</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_address_num_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                r.</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_postal_code_rename</span><span class="si">}</span><span class="s2">, r.</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_directional_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                m.</span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span>
<span class="s2">            FROM   tfidf_matches as m</span>
<span class="s2">            INNER JOIN left_source as l</span>
<span class="s2">                ON m.id_b = l.</span><span class="si">{</span><span class="n">left_address_col</span><span class="si">}</span><span class="s2">_street_name_id</span>
<span class="s2">            INNER JOIN right_source as r</span>
<span class="s2">                ON m.id_a = r.</span><span class="si">{</span><span class="n">right_address_col</span><span class="si">}</span><span class="s2">_street_name_id</span>
<span class="s2">        ),</span>

<span class="s2">        all_fuzzy_matches AS (</span>
<span class="s2">            SELECT </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span>
<span class="s2">            FROM (SELECT * FROM fuzzy_match_1</span>
<span class="s2">                UNION</span>
<span class="s2">                SELECT * FROM fuzzy_match_2)</span>
<span class="s2">            WHERE </span><span class="si">{</span><span class="n">same_condition</span><span class="si">}</span><span class="s2"> AND</span>
<span class="s2">            </span><span class="si">{</span><span class="n">condition</span><span class="si">}</span>

<span class="s2">        ),</span>

<span class="s2">        existing_links AS (</span>
<span class="s2">            SELECT *</span>
<span class="s2">            FROM </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span>
<span class="s2">        )</span>

<span class="s2">        SELECT *</span>
<span class="s2">        FROM   all_fuzzy_matches</span>
<span class="s2">        FULL JOIN existing_links</span>
<span class="s2">            USING(</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_rename</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_rename</span><span class="si">}</span><span class="s2">)</span>

<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">db_conn</span><span class="p">:</span>
            <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow] Created </span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRAGMA table_info(&#39;</span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UPDATE </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2"> SET </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> = 0 WHERE </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> IS NULL&quot;</span><span class="p">)</span>

            <span class="c1"># set datatype to int or float as expected</span>
            <span class="k">if</span> <span class="s2">&quot;fuzzy&quot;</span> <span class="ow">in</span> <span class="n">match_name</span><span class="p">:</span>
                <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UPDATE </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2"> SET </span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span><span class="s2"> = CAST(</span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span><span class="s2"> AS FLOAT)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UPDATE </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2"> SET </span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span><span class="s2"> = CAST(</span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span><span class="s2"> AS INT1)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.link.link_utils.execute_fuzzy_link" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute_fuzzy_link</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">left_entity</span><span class="p">,</span> <span class="n">left_table</span><span class="p">,</span> <span class="n">left_ent_id</span><span class="p">,</span> <span class="n">left_name_col</span><span class="p">,</span> <span class="n">right_entity</span><span class="p">,</span> <span class="n">right_table</span><span class="p">,</span> <span class="n">right_ent_id</span><span class="p">,</span> <span class="n">right_name_col</span><span class="p">,</span> <span class="n">tfidf_table</span><span class="o">=</span><span class="s1">&#39;link.tfidf_staging&#39;</span><span class="p">,</span> <span class="n">link_exclusions</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#chainlink.link.link_utils.execute_fuzzy_link" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Given two tables and a tfidf matching entity table, create a fuzzy match between the two tables.
Creates a match column called
{left_entity}<em>{left_table}</em>{left_name_col}<em>{right_entity}</em>{right_table}<em>{right_name_col}_fuzzy_match
and appends to link table link.{left_entity}</em>{right_entity}</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/link_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute_fuzzy_link</span><span class="p">(</span>
    <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">left_entity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_ent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_name_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_entity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_ent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_name_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tfidf_table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;link.tfidf_staging&quot;</span><span class="p">,</span>
    <span class="n">link_exclusions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Given two tables and a tfidf matching entity table, create a fuzzy match between the two tables.</span>
<span class="sd">    Creates a match column called</span>
<span class="sd">    {left_entity}_{left_table}_{left_name_col}_{right_entity}_{right_table}_{right_name_col}_fuzzy_match</span>
<span class="sd">    and appends to link table link.{left_entity}_{right_entity}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">link_exclusions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">link_exclusions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">link_table</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;link.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># align the names of the match columns</span>
    <span class="n">left_side</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_table</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_name_col</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">right_side</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_table</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_name_col</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">left_entity</span> <span class="o">!=</span> <span class="n">right_entity</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">left_side</span> <span class="o">&lt;</span> <span class="n">right_side</span><span class="p">:</span>
            <span class="n">match_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_side</span><span class="si">}</span><span class="s2">_fuzzy_match&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">match_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_side</span><span class="si">}</span><span class="s2">_fuzzy_match&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">match_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_side</span><span class="si">}</span><span class="s2">_fuzzy_match&quot;</span>

    <span class="c1"># check link exclusion</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">exclusion</span> <span class="ow">in</span> <span class="n">match_name</span> <span class="k">for</span> <span class="n">exclusion</span> <span class="ow">in</span> <span class="n">link_exclusions</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">same_condition</span> <span class="o">=</span> <span class="s2">&quot;TRUE&quot;</span>

    <span class="k">if</span> <span class="n">left_ent_id</span> <span class="o">==</span> <span class="n">right_ent_id</span> <span class="ow">and</span> <span class="n">left_entity</span> <span class="o">==</span> <span class="n">right_entity</span><span class="p">:</span>
        <span class="n">left_ent_id_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_ent_id</span><span class="si">}</span><span class="s2">_1&quot;</span>
        <span class="n">right_ent_id_rename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_ent_id</span><span class="si">}</span><span class="s2">_2&quot;</span>
        <span class="c1"># if same id, want to remove dupes</span>
        <span class="n">same_condition</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_rename</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_rename</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">left_ent_id_rename</span> <span class="o">=</span> <span class="n">left_ent_id</span>
        <span class="n">right_ent_id_rename</span> <span class="o">=</span> <span class="n">right_ent_id</span>

    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    CREATE OR REPLACE TABLE </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2"> AS</span>

<span class="s2">    WITH tfidf_matches AS (</span>
<span class="s2">        SELECT id_a,</span>
<span class="s2">               id_b,</span>
<span class="s2">               similarity as </span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span>
<span class="s2">        FROM </span><span class="si">{</span><span class="n">tfidf_table</span><span class="si">}</span>
<span class="s2">    ),</span>

<span class="s2">    left_source AS (</span>
<span class="s2">        SELECT </span><span class="si">{</span><span class="n">left_ent_id</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                </span><span class="si">{</span><span class="n">left_name_col</span><span class="si">}</span><span class="s2">_name_id</span>
<span class="s2">        FROM </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">left_table</span><span class="si">}</span>
<span class="s2">    ),</span>

<span class="s2">    right_source AS (</span>
<span class="s2">        SELECT </span><span class="si">{</span><span class="n">right_ent_id</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">               </span><span class="si">{</span><span class="n">right_name_col</span><span class="si">}</span><span class="s2">_name_id</span>
<span class="s2">        FROM </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">right_table</span><span class="si">}</span>
<span class="s2">    ),</span>

<span class="s2">    fuzzy_match_1 AS (</span>
<span class="s2">        SELECT l.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">               r.</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">               m.</span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span>
<span class="s2">        FROM   tfidf_matches as m</span>
<span class="s2">        INNER JOIN left_source as l</span>
<span class="s2">            ON m.id_a = l.</span><span class="si">{</span><span class="n">left_name_col</span><span class="si">}</span><span class="s2">_name_id</span>
<span class="s2">        INNER JOIN right_source as r</span>
<span class="s2">            ON m.id_b = r.</span><span class="si">{</span><span class="n">right_name_col</span><span class="si">}</span><span class="s2">_name_id</span>
<span class="s2">    ),</span>

<span class="s2">    fuzzy_match_2 AS (</span>
<span class="s2">        SELECT l.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">               r.</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_rename</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">               m.</span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span>
<span class="s2">        FROM   tfidf_matches as m</span>
<span class="s2">        INNER JOIN left_source as l</span>
<span class="s2">            ON m.id_b = l.</span><span class="si">{</span><span class="n">left_name_col</span><span class="si">}</span><span class="s2">_name_id</span>
<span class="s2">        INNER JOIN right_source as r</span>
<span class="s2">            ON m.id_a = r.</span><span class="si">{</span><span class="n">right_name_col</span><span class="si">}</span><span class="s2">_name_id</span>
<span class="s2">    ),</span>

<span class="s2">    all_fuzzy_matches AS (</span>
<span class="s2">        SELECT *</span>
<span class="s2">        FROM (SELECT * FROM fuzzy_match_1</span>
<span class="s2">              UNION</span>
<span class="s2">              SELECT * FROM fuzzy_match_2)</span>
<span class="s2">        where </span><span class="si">{</span><span class="n">same_condition</span><span class="si">}</span>
<span class="s2">    ),</span>

<span class="s2">    existing_links AS (</span>
<span class="s2">        SELECT *</span>
<span class="s2">        FROM </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span>
<span class="s2">    )</span>

<span class="s2">    SELECT *</span>
<span class="s2">    FROM   all_fuzzy_matches</span>
<span class="s2">    FULL JOIN existing_links</span>
<span class="s2">        USING(</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_rename</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_rename</span><span class="si">}</span><span class="s2">)</span>

<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">db_conn</span><span class="p">:</span>
        <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow] Created </span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRAGMA table_info(&#39;</span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UPDATE </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2"> SET </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> = 0 WHERE </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> IS NULL&quot;</span><span class="p">)</span>

        <span class="c1"># set datatype to int or float as expected</span>
        <span class="k">if</span> <span class="s2">&quot;fuzzy&quot;</span> <span class="ow">in</span> <span class="n">match_name</span><span class="p">:</span>
            <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UPDATE </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2"> SET </span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span><span class="s2"> = CAST(</span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span><span class="s2"> AS FLOAT)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UPDATE </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2"> SET </span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span><span class="s2"> = CAST(</span><span class="si">{</span><span class="n">match_name</span><span class="si">}</span><span class="s2"> AS INT1)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.link.link_utils.execute_match" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute_match</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">match_type</span><span class="p">,</span> <span class="n">left_entity</span><span class="p">,</span> <span class="n">left_table</span><span class="p">,</span> <span class="n">left_matching_col</span><span class="p">,</span> <span class="n">left_matching_id</span><span class="p">,</span> <span class="n">left_ent_id</span><span class="p">,</span> <span class="n">right_entity</span><span class="p">,</span> <span class="n">right_table</span><span class="p">,</span> <span class="n">right_matching_col</span><span class="p">,</span> <span class="n">right_matching_id</span><span class="p">,</span> <span class="n">right_ent_id</span><span class="p">,</span> <span class="n">skip_address</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">link_exclusions</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#chainlink.link.link_utils.execute_match" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Exact matches between two column in two tables.
Creates a match column called
{left_entity}<em>{left_table}</em>{left_matching_col}<em>{right_entity}</em>{right_table}<em>{right_matching_col}</em>{match_type}
and appends to link table link.{left_entity}_{right_entity}</p>
<p>Returns: None</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/link_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute_match</span><span class="p">(</span>
    <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">match_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_entity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_matching_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_matching_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_ent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_entity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_matching_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_matching_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_ent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">skip_address</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">link_exclusions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exact matches between two column in two tables.</span>
<span class="sd">    Creates a match column called</span>
<span class="sd">    {left_entity}_{left_table}_{left_matching_col}_{right_entity}_{right_table}_{right_matching_col}_{match_type}</span>
<span class="sd">    and appends to link table link.{left_entity}_{right_entity}</span>

<span class="sd">    Returns: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">link_exclusions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">link_exclusions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># if two different ids just dont want duplicates</span>
    <span class="n">matching_condition</span> <span class="o">=</span> <span class="s2">&quot;!=&quot;</span>

    <span class="k">if</span> <span class="n">left_ent_id</span> <span class="o">==</span> <span class="n">right_ent_id</span> <span class="ow">and</span> <span class="n">left_entity</span> <span class="o">==</span> <span class="n">right_entity</span><span class="p">:</span>
        <span class="n">left_ent_id_edit</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_ent_id</span><span class="si">}</span><span class="s2">_1&quot;</span>
        <span class="n">right_ent_id_edit</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_ent_id</span><span class="si">}</span><span class="s2">_2&quot;</span>
        <span class="c1"># if same id, only want one direction of matches</span>
        <span class="n">matching_condition</span> <span class="o">=</span> <span class="s2">&quot;&lt;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">left_ent_id_edit</span> <span class="o">=</span> <span class="n">left_ent_id</span>
        <span class="n">right_ent_id_edit</span> <span class="o">=</span> <span class="n">right_ent_id</span>

    <span class="n">link_table</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;link.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># align the names of the match columns</span>
    <span class="n">left_side</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_table</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_matching_col</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">right_side</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_table</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_matching_col</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">left_entity</span> <span class="o">!=</span> <span class="n">right_entity</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">left_side</span> <span class="o">&lt;</span> <span class="n">right_side</span><span class="p">:</span>
            <span class="n">match_name_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">match_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">match_name_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">match_type</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">match_name_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">match_type</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># check link exclusion</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">exclusion</span> <span class="ow">in</span> <span class="n">match_name_col</span> <span class="k">for</span> <span class="n">exclusion</span> <span class="ow">in</span> <span class="n">link_exclusions</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">skip_address</span><span class="p">:</span>
        <span class="n">address_condition</span> <span class="o">=</span> <span class="s2">&quot; != 1&quot;</span>
        <span class="n">left_address_condition</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;l.</span><span class="si">{</span><span class="n">left_matching_col</span><span class="si">}</span><span class="s2">_skip </span><span class="si">{</span><span class="n">address_condition</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">right_address_condition</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;r.</span><span class="si">{</span><span class="n">right_matching_col</span><span class="si">}</span><span class="s2">_skip </span><span class="si">{</span><span class="n">address_condition</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">left_extra_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">left_matching_col</span><span class="si">}</span><span class="s2">_skip&quot;</span>
        <span class="n">right_extra_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">right_matching_col</span><span class="si">}</span><span class="s2">_skip&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">left_address_condition</span> <span class="o">=</span> <span class="s2">&quot;TRUE&quot;</span>
        <span class="n">right_address_condition</span> <span class="o">=</span> <span class="s2">&quot;TRUE&quot;</span>
        <span class="n">left_extra_col</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">right_extra_col</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">temp_table</span> <span class="o">=</span> <span class="n">match_name_col</span> <span class="o">+</span> <span class="s2">&quot;_table&quot;</span>

    <span class="n">matching_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE SCHEMA IF NOT EXISTS link;</span>

<span class="s2">            CREATE OR REPLACE TABLE link.</span><span class="si">{</span><span class="n">temp_table</span><span class="si">}</span><span class="s2"> AS</span>
<span class="s2">            SELECT l.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_edit</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                   r.</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_edit</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                   1 AS </span><span class="si">{</span><span class="n">match_name_col</span><span class="si">}</span>
<span class="s2">            FROM</span>
<span class="s2">                (SELECT </span><span class="si">{</span><span class="n">left_ent_id</span><span class="si">}</span><span class="s2"> AS </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_edit</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                        </span><span class="si">{</span><span class="n">left_matching_id</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">left_extra_col</span><span class="si">}</span>
<span class="s2">                FROM </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">left_table</span><span class="si">}</span>
<span class="s2">                ) as l</span>
<span class="s2">            JOIN</span>
<span class="s2">                (SELECT </span><span class="si">{</span><span class="n">right_ent_id</span><span class="si">}</span><span class="s2"> AS </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_edit</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                        </span><span class="si">{</span><span class="n">right_matching_id</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">right_extra_col</span><span class="si">}</span>
<span class="s2">                FROM </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">right_table</span><span class="si">}</span>
<span class="s2">                ) as r</span>
<span class="s2">                ON l.</span><span class="si">{</span><span class="n">left_matching_id</span><span class="si">}</span><span class="s2"> = r.</span><span class="si">{</span><span class="n">right_matching_id</span><span class="si">}</span>
<span class="s2">                AND l.</span><span class="si">{</span><span class="n">left_matching_id</span><span class="si">}</span><span class="s2"> IS NOT NULL</span>
<span class="s2">                AND r.</span><span class="si">{</span><span class="n">right_matching_id</span><span class="si">}</span><span class="s2"> IS NOT NULL</span>
<span class="s2">                AND l.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_edit</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">matching_condition</span><span class="si">}</span><span class="s2"> r.</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_edit</span><span class="si">}</span>
<span class="s2">            WHERE</span>
<span class="s2">                </span><span class="si">{</span><span class="n">left_address_condition</span><span class="si">}</span>
<span class="s2">                AND </span><span class="si">{</span><span class="n">right_address_condition</span><span class="si">}</span>
<span class="s2">        ;&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">db_conn</span><span class="p">:</span>
        <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">matching_query</span><span class="p">)</span>
        <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow] Created </span><span class="si">{</span><span class="n">match_name_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="n">match_name_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">execute_match_processing</span><span class="p">(</span>
            <span class="n">db_conn</span><span class="o">=</span><span class="n">db_conn</span><span class="p">,</span>
            <span class="n">link_table</span><span class="o">=</span><span class="n">link_table</span><span class="p">,</span>
            <span class="n">out_temp_table_name</span><span class="o">=</span><span class="n">temp_table</span><span class="p">,</span>
            <span class="n">id_col_1</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_edit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">match_name_col</span><span class="o">=</span><span class="n">match_name_col</span><span class="p">,</span>
            <span class="n">id_col_2</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_edit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished match processing for </span><span class="si">{</span><span class="n">match_name_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.link.link_utils.execute_match_address" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute_match_address</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">left_entity</span><span class="p">,</span> <span class="n">left_table</span><span class="p">,</span> <span class="n">left_address</span><span class="p">,</span> <span class="n">left_ent_id</span><span class="p">,</span> <span class="n">right_entity</span><span class="p">,</span> <span class="n">right_table</span><span class="p">,</span> <span class="n">right_address</span><span class="p">,</span> <span class="n">right_ent_id</span><span class="p">,</span> <span class="n">skip_address</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">link_exclusions</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#chainlink.link.link_utils.execute_match_address" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>given a two address columns, match the addresses:
    * match by raw address string
    * match by clean street string
    * if street id matches, match by unit
    * match street name and number if zipcode matches</p>
<p>Creates four match columns called
{left_entity}<em>{left_table}</em>{left_matching_col}<em>{right_entity}</em>{right_table}<em>{right_matching_col}</em>{match_type}
and appends to link table link.{left_entity}_{right_entity}</p>
<p>Returns: None</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/link_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute_match_address</span><span class="p">(</span>
    <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">left_entity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_ent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_entity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_ent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">skip_address</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">link_exclusions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    given a two address columns, match the addresses:</span>
<span class="sd">        * match by raw address string</span>
<span class="sd">        * match by clean street string</span>
<span class="sd">        * if street id matches, match by unit</span>
<span class="sd">        * match street name and number if zipcode matches</span>

<span class="sd">    Creates four match columns called</span>
<span class="sd">    {left_entity}_{left_table}_{left_matching_col}_{right_entity}_{right_table}_{right_matching_col}_{match_type}</span>
<span class="sd">    and appends to link table link.{left_entity}_{right_entity}</span>



<span class="sd">    Returns: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">link_exclusions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">link_exclusions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">## Match by raw address string and by street id</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;street&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing </span><span class="si">{</span><span class="n">match</span><span class="si">}</span><span class="s2"> match&quot;</span><span class="p">)</span>
        <span class="n">execute_match</span><span class="p">(</span>
            <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
            <span class="n">match_type</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">match</span><span class="si">}</span><span class="s2">_match&quot;</span><span class="p">,</span>
            <span class="n">left_entity</span><span class="o">=</span><span class="n">left_entity</span><span class="p">,</span>
            <span class="n">left_table</span><span class="o">=</span><span class="n">left_table</span><span class="p">,</span>
            <span class="n">left_matching_col</span><span class="o">=</span><span class="n">left_address</span><span class="p">,</span>
            <span class="n">left_matching_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_address</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">match</span><span class="si">}</span><span class="s2">_id&quot;</span><span class="p">,</span>
            <span class="n">left_ent_id</span><span class="o">=</span><span class="n">left_ent_id</span><span class="p">,</span>
            <span class="n">right_entity</span><span class="o">=</span><span class="n">right_entity</span><span class="p">,</span>
            <span class="n">right_table</span><span class="o">=</span><span class="n">right_table</span><span class="p">,</span>
            <span class="n">right_matching_col</span><span class="o">=</span><span class="n">right_address</span><span class="p">,</span>
            <span class="n">right_matching_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_address</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">match</span><span class="si">}</span><span class="s2">_id&quot;</span><span class="p">,</span>
            <span class="n">right_ent_id</span><span class="o">=</span><span class="n">right_ent_id</span><span class="p">,</span>
            <span class="n">skip_address</span><span class="o">=</span><span class="n">skip_address</span><span class="p">,</span>
            <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1">## If street id matches, match by unit</span>
    <span class="n">left_side</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_table</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_address</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">right_side</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_table</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_address</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">left_entity</span> <span class="o">!=</span> <span class="n">right_entity</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">left_side</span> <span class="o">&lt;</span> <span class="n">right_side</span><span class="p">:</span>
            <span class="n">street_match_to_check</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_side</span><span class="si">}</span><span class="s2">_street_match&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">street_match_to_check</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_side</span><span class="si">}</span><span class="s2">_street_match&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">street_match_to_check</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_side</span><span class="si">}</span><span class="s2">_street_match&quot;</span>

    <span class="n">execute_match_unit</span><span class="p">(</span>
        <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
        <span class="n">left_entity</span><span class="o">=</span><span class="n">left_entity</span><span class="p">,</span>
        <span class="n">right_entity</span><span class="o">=</span><span class="n">right_entity</span><span class="p">,</span>
        <span class="c1"># TODO will ording of left and right address mess things up</span>
        <span class="n">street_match_to_check</span><span class="o">=</span><span class="n">street_match_to_check</span><span class="p">,</span>
        <span class="n">left_table</span><span class="o">=</span><span class="n">left_table</span><span class="p">,</span>
        <span class="n">left_address</span><span class="o">=</span><span class="n">left_address</span><span class="p">,</span>
        <span class="n">left_ent_id</span><span class="o">=</span><span class="n">left_ent_id</span><span class="p">,</span>
        <span class="n">right_table</span><span class="o">=</span><span class="n">right_table</span><span class="p">,</span>
        <span class="n">right_address</span><span class="o">=</span><span class="n">right_address</span><span class="p">,</span>
        <span class="n">right_ent_id</span><span class="o">=</span><span class="n">right_ent_id</span><span class="p">,</span>
        <span class="n">skip_address</span><span class="o">=</span><span class="n">skip_address</span><span class="p">,</span>
        <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.link.link_utils.execute_match_processing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute_match_processing</span><span class="p">(</span><span class="n">db_conn</span><span class="p">,</span> <span class="n">link_table</span><span class="p">,</span> <span class="n">out_temp_table_name</span><span class="p">,</span> <span class="n">id_col_1</span><span class="p">,</span> <span class="n">match_name_col</span><span class="p">,</span> <span class="n">id_col_2</span><span class="p">)</span></code>

<a href="#chainlink.link.link_utils.execute_match_processing" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Steps to run after matches are created.
append matches to link table, set null matches to 0, and drop temp table of matches
runs in execute_match()</p>
<p>Returns: None</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/link_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute_match_processing</span><span class="p">(</span>
    <span class="n">db_conn</span><span class="p">:</span> <span class="n">DuckDBPyConnection</span><span class="p">,</span>
    <span class="n">link_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">out_temp_table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">id_col_1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">match_name_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">id_col_2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Steps to run after matches are created.</span>
<span class="sd">    append matches to link table, set null matches to 0, and drop temp table of matches</span>
<span class="sd">    runs in execute_match()</span>

<span class="sd">    Returns: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check if link table exists</span>
    <span class="n">link_table_check</span> <span class="o">=</span> <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;SELECT COUNT(*)</span>
<span class="s2">        FROM information_schema.tables</span>
<span class="s2">        WHERE table_name = &#39;</span><span class="si">{</span><span class="n">link_table</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">               and table_schema = &#39;</span><span class="si">{</span><span class="n">link_table</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">link_table_exists</span> <span class="o">=</span> <span class="n">link_table_check</span> <span class="o">!=</span> <span class="mi">0</span>

    <span class="c1"># append to link table</span>
    <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_append_to_links</span><span class="p">(</span><span class="n">link_table_exists</span><span class="p">,</span> <span class="n">link_table</span><span class="p">,</span> <span class="n">out_temp_table_name</span><span class="p">,</span> <span class="n">id_col_1</span><span class="p">,</span> <span class="n">id_col_2</span><span class="p">))</span>

    <span class="c1"># set null matches to 0</span>
    <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UPDATE </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2"> SET </span><span class="si">{</span><span class="n">match_name_col</span><span class="si">}</span><span class="s2"> = 0 WHERE </span><span class="si">{</span><span class="n">match_name_col</span><span class="si">}</span><span class="s2"> IS NULL&quot;</span><span class="p">)</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRAGMA table_info(&#39;</span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UPDATE </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2"> SET </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> = 0 WHERE </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> IS NULL&quot;</span><span class="p">)</span>

    <span class="c1"># set datatype to int or float as expected</span>
    <span class="k">if</span> <span class="s2">&quot;fuzzy&quot;</span> <span class="ow">in</span> <span class="n">match_name_col</span><span class="p">:</span>
        <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UPDATE </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2"> SET </span><span class="si">{</span><span class="n">match_name_col</span><span class="si">}</span><span class="s2"> = CAST(</span><span class="si">{</span><span class="n">match_name_col</span><span class="si">}</span><span class="s2"> AS FLOAT)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UPDATE </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2"> SET </span><span class="si">{</span><span class="n">match_name_col</span><span class="si">}</span><span class="s2"> = CAST(</span><span class="si">{</span><span class="n">match_name_col</span><span class="si">}</span><span class="s2"> AS INT1)&quot;</span><span class="p">)</span>

    <span class="c1"># drop temp table of matches</span>
    <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DROP TABLE link.</span><span class="si">{</span><span class="n">out_temp_table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.link.link_utils.execute_match_unit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute_match_unit</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">left_entity</span><span class="p">,</span> <span class="n">right_entity</span><span class="p">,</span> <span class="n">street_match_to_check</span><span class="p">,</span> <span class="n">left_table</span><span class="p">,</span> <span class="n">left_address</span><span class="p">,</span> <span class="n">left_ent_id</span><span class="p">,</span> <span class="n">right_table</span><span class="p">,</span> <span class="n">right_address</span><span class="p">,</span> <span class="n">right_ent_id</span><span class="p">,</span> <span class="n">skip_address</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">link_exclusions</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#chainlink.link.link_utils.execute_match_unit" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Given two address columns, if street id matches, match by unit.</p>
<p>Creates a match column called
{left_entity}<em>{left_table}</em>{left_address}<em>{right_entity}</em>{right_table}<em>{right_address}_unit_match
and appends to link table link.{left_entity}</em>{right_entity}</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/link_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute_match_unit</span><span class="p">(</span>
    <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">left_entity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_entity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">street_match_to_check</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">left_ent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">right_ent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">skip_address</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">link_exclusions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given two address columns, if street id matches, match by unit.</span>

<span class="sd">    Creates a match column called</span>
<span class="sd">    {left_entity}_{left_table}_{left_address}_{right_entity}_{right_table}_{right_address}_unit_match</span>
<span class="sd">    and appends to link table link.{left_entity}_{right_entity}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">link_exclusions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">link_exclusions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># if same id, only want one direction of matches</span>
    <span class="k">if</span> <span class="n">left_ent_id</span> <span class="o">==</span> <span class="n">right_ent_id</span> <span class="ow">and</span> <span class="n">left_entity</span> <span class="o">==</span> <span class="n">right_entity</span><span class="p">:</span>
        <span class="n">left_ent_id_edit</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_ent_id</span><span class="si">}</span><span class="s2">_1&quot;</span>
        <span class="n">right_ent_id_edit</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_ent_id</span><span class="si">}</span><span class="s2">_2&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">left_ent_id_edit</span> <span class="o">=</span> <span class="n">left_ent_id</span>
        <span class="n">right_ent_id_edit</span> <span class="o">=</span> <span class="n">right_ent_id</span>

    <span class="n">link_table</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;link.</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># align the names of the match columns</span>
    <span class="n">left_side</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_table</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_address</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">right_side</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_table</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_address</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">left_entity</span> <span class="o">!=</span> <span class="n">right_entity</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">left_side</span> <span class="o">&lt;</span> <span class="n">right_side</span><span class="p">:</span>
            <span class="n">match_name_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_side</span><span class="si">}</span><span class="s2">_unit_match&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">match_name_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_side</span><span class="si">}</span><span class="s2">_unit_match&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">match_name_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_side</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_side</span><span class="si">}</span><span class="s2">_unit_match&quot;</span>
    <span class="c1"># check link exclusion</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">exclusion</span> <span class="ow">in</span> <span class="n">match_name_col</span> <span class="k">for</span> <span class="n">exclusion</span> <span class="ow">in</span> <span class="n">link_exclusions</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">skip_address</span><span class="p">:</span>
        <span class="n">address_condition</span> <span class="o">=</span> <span class="s2">&quot; != 1&quot;</span>
        <span class="n">left_address_condition</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_address</span><span class="si">}</span><span class="s2">_skip </span><span class="si">{</span><span class="n">address_condition</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">right_address_condition</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_address</span><span class="si">}</span><span class="s2">_skip </span><span class="si">{</span><span class="n">address_condition</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">left_address_condition</span> <span class="o">=</span> <span class="s2">&quot;TRUE&quot;</span>
        <span class="n">right_address_condition</span> <span class="o">=</span> <span class="s2">&quot;TRUE&quot;</span>

    <span class="n">temp_table</span> <span class="o">=</span> <span class="n">match_name_col</span> <span class="o">+</span> <span class="s2">&quot;_table&quot;</span>

    <span class="n">matching_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        CREATE OR REPLACE TABLE link.</span><span class="si">{</span><span class="n">temp_table</span><span class="si">}</span><span class="s2"> AS</span>

<span class="s2">        WITH link as (</span>
<span class="s2">            SELECT </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_edit</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_edit</span><span class="si">}</span>
<span class="s2">            FROM </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span>
<span class="s2">            WHERE </span><span class="si">{</span><span class="n">street_match_to_check</span><span class="si">}</span><span class="s2"> = 1</span>
<span class="s2">            )</span>

<span class="s2">        ,lhs as (</span>
<span class="s2">            SELECT </span><span class="si">{</span><span class="n">left_ent_id</span><span class="si">}</span><span class="s2"> AS </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_edit</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">left_address</span><span class="si">}</span><span class="s2">_unit_number AS unit_1</span>
<span class="s2">            FROM </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">left_table</span><span class="si">}</span>
<span class="s2">            where </span><span class="si">{</span><span class="n">left_address_condition</span><span class="si">}</span>

<span class="s2">            )</span>

<span class="s2">        , rhs as (</span>
<span class="s2">            SELECT </span><span class="si">{</span><span class="n">right_ent_id</span><span class="si">}</span><span class="s2"> AS </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_edit</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">right_address</span><span class="si">}</span><span class="s2">_unit_number AS unit_2</span>
<span class="s2">            FROM </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">right_table</span><span class="si">}</span>
<span class="s2">            where </span><span class="si">{</span><span class="n">right_address_condition</span><span class="si">}</span>
<span class="s2">            )</span>

<span class="s2">        SELECT </span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_edit</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">               </span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_edit</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">               1 AS </span><span class="si">{</span><span class="n">match_name_col</span><span class="si">}</span>
<span class="s2">        FROM link</span>
<span class="s2">        LEFT JOIN lhs</span>
<span class="s2">        USING(</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_edit</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">        LEFT JOIN rhs</span>
<span class="s2">        USING(</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_edit</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">        WHERE unit_1 IS NOT NULL</span>
<span class="s2">        AND unit_2 IS NOT NULL</span>
<span class="s2">        AND CAST(unit_1 AS VARCHAR) = CAST(unit_2 AS VARCHAR);&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">db_conn</span><span class="p">:</span>
        <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">matching_query</span><span class="p">)</span>
        <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow] Created </span><span class="si">{</span><span class="n">match_name_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="n">match_name_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">execute_match_processing</span><span class="p">(</span>
            <span class="n">db_conn</span><span class="o">=</span><span class="n">db_conn</span><span class="p">,</span>
            <span class="n">link_table</span><span class="o">=</span><span class="n">link_table</span><span class="p">,</span>
            <span class="n">out_temp_table_name</span><span class="o">=</span><span class="n">temp_table</span><span class="p">,</span>
            <span class="n">id_col_1</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">left_ent_id_edit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">match_name_col</span><span class="o">=</span><span class="n">match_name_col</span><span class="p">,</span>
            <span class="n">id_col_2</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_entity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">right_ent_id_edit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.link.link_utils.generate_combos_within_across_tables" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_combos_within_across_tables</span><span class="p">(</span><span class="n">name_idx</span><span class="p">,</span> <span class="n">address_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#chainlink.link.link_utils.generate_combos_within_across_tables" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>create all possible combinations of across tables in the same entity,
but do not include combos within the same table
if address_idx is not empty, also create across combos between address tables</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/link_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_combos_within_across_tables</span><span class="p">(</span><span class="n">name_idx</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">address_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create all possible combinations of across tables in the same entity,</span>
<span class="sd">    but do not include combos within the same table</span>
<span class="sd">    if address_idx is not empty, also create across combos between address tables</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">address_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">address_idx</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">across_combos_name_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">name_idx</span><span class="p">)),</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">across_name_combos</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">across_combos_name_idx</span><span class="p">:</span>
        <span class="n">across_name_combos</span> <span class="o">+=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">name_idx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">name_idx</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">across_name_combos</span> <span class="o">+=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">name_idx</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">name_idx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">address_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">across_address_combos</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">across_combos_address_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">address_idx</span><span class="p">)),</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">across_combos_address_idx</span><span class="p">:</span>
            <span class="n">across_address_combos</span> <span class="o">+=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">address_idx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">address_idx</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">across_address_combos</span> <span class="o">+=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">address_idx</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">address_idx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">across_name_combos</span><span class="p">,</span> <span class="n">across_address_combos</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">across_name_combos</span><span class="p">,</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.link.link_utils.generate_tfidf_links" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_tfidf_links</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">table_location</span><span class="o">=</span><span class="s1">&#39;entity.name_similarity&#39;</span><span class="p">,</span> <span class="n">source_table_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#chainlink.link.link_utils.generate_tfidf_links" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>create a table of tfidf matches between two entities and adds to db</p>
<p>Returns: None</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/link_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_tfidf_links</span><span class="p">(</span>
    <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">table_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;entity.name_similarity&quot;</span><span class="p">,</span>
    <span class="n">source_table_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create a table of tfidf matches between two entities and adds to db</span>

<span class="sd">    Returns: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[yellow] Process started&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Process started&quot;</span><span class="p">)</span>

    <span class="c1"># retrieve entity list, print length of dataframe</span>
    <span class="n">entity_list</span> <span class="o">=</span> <span class="n">database_query</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="n">source_table_name</span><span class="p">)</span>
    <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow] Query retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">entity_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">entity_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>

    <span class="c1"># returns a pandas df</span>
    <span class="n">entity_col</span> <span class="o">=</span> <span class="n">entity_list</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">id_col</span> <span class="o">=</span> <span class="n">entity_list</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">matches_df</span> <span class="o">=</span> <span class="n">superfast_tfidf</span><span class="p">(</span><span class="n">entity_list</span><span class="p">,</span> <span class="n">id_col</span><span class="p">,</span> <span class="n">entity_col</span><span class="p">)</span>

    <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[yellow] Fuzzy Matching done&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fuzzy Matching done&quot;</span><span class="p">)</span>

    <span class="c1"># load back to db</span>
    <span class="k">with</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">db_conn</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;CREATE OR REPLACE TABLE </span><span class="si">{</span><span class="n">table_location</span><span class="si">}</span><span class="s2"> AS</span>
<span class="s2">                    SELECT *</span>
<span class="s2">                    FROM  matches_df&quot;&quot;&quot;</span>

        <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.link.link_utils.query_append_to_links" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">query_append_to_links</span><span class="p">(</span><span class="n">link_table_exists</span><span class="p">,</span> <span class="n">link_table</span><span class="p">,</span> <span class="n">table_to_append</span><span class="p">,</span> <span class="n">id_col1</span><span class="p">,</span> <span class="n">id_col2</span><span class="p">)</span></code>

<a href="#chainlink.link.link_utils.query_append_to_links" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>query to append links to link table
runs in execute_match_processing()</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/link_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">query_append_to_links</span><span class="p">(</span>
    <span class="n">link_table_exists</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">link_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">table_to_append</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">id_col1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">id_col2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    query to append links to link table</span>
<span class="sd">    runs in execute_match_processing()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if link table does not exist then its just table to append</span>
    <span class="k">if</span> <span class="n">link_table_exists</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE OR REPLACE TABLE </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2"> AS</span>
<span class="s2">        SELECT DISTINCT *</span>
<span class="s2">        FROM </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span>
<span class="s2">        FULL JOIN link.</span><span class="si">{</span><span class="n">table_to_append</span><span class="si">}</span>
<span class="s2">        USING(</span><span class="si">{</span><span class="n">id_col1</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">id_col2</span><span class="si">}</span><span class="s2">)&quot;&quot;&quot;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE OR REPLACE TABLE </span><span class="si">{</span><span class="n">link_table</span><span class="si">}</span><span class="s2"> AS</span>
<span class="s2">        SELECT DISTINCT *</span>
<span class="s2">        FROM link.</span><span class="si">{</span><span class="n">table_to_append</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">query</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="chainlink.link.tfidf_utils" class="doc doc-heading">
            <code>tfidf_utils</code>


<a href="#chainlink.link.tfidf_utils" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="chainlink.link.tfidf_utils.adjust_and_replace" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">adjust_and_replace</span><span class="p">(</span><span class="n">string</span><span class="p">)</span></code>

<a href="#chainlink.link.tfidf_utils.adjust_and_replace" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>replace specified words with blanks and other words with their corresponding values for ngrams</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/tfidf_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">adjust_and_replace</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    replace specified words with blanks and other words with their corresponding values for ngrams</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># remove punctuation</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[,-./]&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>

    <span class="c1"># split the string into words</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="c1"># replace words based on blank_words and flat_ngram_adj using list comprehension</span>
    <span class="n">adjusted_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">blank_words</span> <span class="k">else</span> <span class="n">flat_ngram_adj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">adjusted_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.link.tfidf_utils.clean_matches" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clean_matches</span><span class="p">(</span><span class="n">matches_df</span><span class="p">)</span></code>

<a href="#chainlink.link.tfidf_utils.clean_matches" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>remove self matches and duplicates in match dataframe</p>
<p>Returns: pl.DataFrame</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/tfidf_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clean_matches</span><span class="p">(</span><span class="n">matches_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    remove self matches and duplicates in match dataframe</span>

<span class="sd">    Returns: pl.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># create copy to make adjustments</span>
    <span class="c1"># matches_df = matches_df.copy()</span>
    <span class="c1"># remove self matches, duplicates and sort</span>
    <span class="n">matches_df</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">matches_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;id_a&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;id_b&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">concat_list</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;id_a&quot;</span><span class="p">,</span> <span class="s2">&quot;id_b&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;sorted_id_pairs&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="s2">&quot;sorted_id_pairs&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;sorted_id_pairs&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;similarity&quot;</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">matches_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.link.tfidf_utils.database_query" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">database_query</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#chainlink.link.tfidf_utils.database_query" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>queries entities for comparison</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/tfidf_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">database_query</span><span class="p">(</span><span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    queries entities for comparison</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">table_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;entity.name&quot;</span>
        <span class="n">id_col</span> <span class="o">=</span> <span class="s2">&quot;name_id&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">id_col</span> <span class="o">=</span> <span class="n">table_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_id&quot;</span>

    <span class="c1"># start connection with woc db</span>
    <span class="k">with</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">entity_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT entity, </span><span class="si">{</span><span class="n">id_col</span><span class="si">}</span>
<span class="s2">        FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="c1"># retreive entity list (all unique names in parcel, llc and corp data</span>
        <span class="n">entity_list</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">entity_query</span><span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span>

        <span class="c1"># randomized sample for limit</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">entity_list</span> <span class="o">=</span> <span class="n">entity_list</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">entity_list</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.link.tfidf_utils.get_matches_df" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_matches_df</span><span class="p">(</span><span class="n">sparse_matrix</span><span class="p">,</span> <span class="n">name_vector</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#chainlink.link.tfidf_utils.get_matches_df" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>create a matches dataframe given matrix of ngrams
references
    sparse_matrix - matrix from vectorized comparison calculations
    name_vector - list of names to compare
    id_vector - id of distinct name from entities list</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/tfidf_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_matches_df</span><span class="p">(</span><span class="n">sparse_matrix</span><span class="p">:</span> <span class="n">csr_matrix</span><span class="p">,</span> <span class="n">name_vector</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">top</span><span class="p">:</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create a matches dataframe given matrix of ngrams</span>
<span class="sd">    references</span>
<span class="sd">        sparse_matrix - matrix from vectorized comparison calculations</span>
<span class="sd">        name_vector - list of names to compare</span>
<span class="sd">        id_vector - id of distinct name from entities list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">non_zeros</span> <span class="o">=</span> <span class="n">sparse_matrix</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>

    <span class="n">sparserows</span> <span class="o">=</span> <span class="n">non_zeros</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sparsecols</span> <span class="o">=</span> <span class="n">non_zeros</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">nr_matches</span> <span class="o">=</span> <span class="n">top</span> <span class="k">if</span> <span class="n">top</span> <span class="k">else</span> <span class="n">sparsecols</span><span class="o">.</span><span class="n">size</span>

    <span class="n">entity_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">nr_matches</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">entity_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">nr_matches</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">similarity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nr_matches</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nr_matches</span><span class="p">):</span>
        <span class="n">entity_a</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_vector</span><span class="p">[</span><span class="n">sparserows</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
        <span class="n">entity_b</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_vector</span><span class="p">[</span><span class="n">sparsecols</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
        <span class="n">similarity</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">sparse_matrix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;entity_a&quot;</span><span class="p">:</span> <span class="n">entity_a</span><span class="p">,</span>
        <span class="s2">&quot;entity_b&quot;</span><span class="p">:</span> <span class="n">entity_b</span><span class="p">,</span>
        <span class="s2">&quot;similarity&quot;</span><span class="p">:</span> <span class="n">similarity</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;entity_a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">hash</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;id_a&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;entity_b&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">hash</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;id_b&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.link.tfidf_utils.ngrams" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ngrams</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></code>

<a href="#chainlink.link.tfidf_utils.ngrams" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>split string into substrings of length n, return list of substrings</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/tfidf_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ngrams</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    split string into substrings of length n, return list of substrings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pre_processing</span> <span class="o">=</span> <span class="n">adjust_and_replace</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">ngrams</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">pre_processing</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ngram</span><span class="p">)</span> <span class="k">for</span> <span class="n">ngram</span> <span class="ow">in</span> <span class="n">ngrams</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.link.tfidf_utils.superfast_tfidf" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">superfast_tfidf</span><span class="p">(</span><span class="n">entity_list</span><span class="p">,</span> <span class="n">id_col</span><span class="o">=</span><span class="s1">&#39;name_id&#39;</span><span class="p">,</span> <span class="n">entity_col</span><span class="o">=</span><span class="s1">&#39;entity&#39;</span><span class="p">)</span></code>

<a href="#chainlink.link.tfidf_utils.superfast_tfidf" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>returns sorted list of top matched names</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/link/tfidf_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">superfast_tfidf</span><span class="p">(</span><span class="n">entity_list</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">id_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;name_id&quot;</span><span class="p">,</span> <span class="n">entity_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;entity&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    returns sorted list of top matched names</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># matching</span>

    <span class="n">entity_list</span> <span class="o">=</span> <span class="n">entity_list</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">entity_col</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">())</span>
    <span class="n">company_names</span> <span class="o">=</span> <span class="n">entity_list</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">entity_col</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">company_names</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">matches_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;entity_a&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;entity_b&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;similarity&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;id_a&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;id_b&quot;</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="k">return</span> <span class="n">matches_df</span>
    <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">min_df</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">analyzer</span><span class="o">=</span><span class="n">ngrams</span><span class="p">)</span>
    <span class="n">tf_idf_matrix</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">company_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">sp_matmul_topn</span><span class="p">(</span><span class="n">tf_idf_matrix</span><span class="p">,</span> <span class="n">tf_idf_matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_threads</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">matches_df</span> <span class="o">=</span> <span class="n">get_matches_df</span><span class="p">(</span><span class="n">sparse_matrix</span><span class="o">=</span><span class="n">matches</span><span class="p">,</span> <span class="n">name_vector</span><span class="o">=</span><span class="n">company_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
    <span class="n">matches_df</span> <span class="o">=</span> <span class="n">clean_matches</span><span class="p">(</span><span class="n">matches_df</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">matches_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="chainlink.load" class="doc doc-heading">
            <code>load</code>


<a href="#chainlink.load" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="chainlink.load.load_generic" class="doc doc-heading">
            <code>load_generic</code>


<a href="#chainlink.load.load_generic" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="chainlink.load.load_generic.load_generic" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_generic</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">schema_config</span><span class="p">,</span> <span class="n">bad_addresses</span><span class="p">)</span></code>

<a href="#chainlink.load.load_generic.load_generic" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Loads a generic file into the database.</p>
<p>Reads config file, loops through each file listed, cleans the data,
creates a unique id for name, street, and street_name,
loads into cleaned files into a database using the schema name from the config file,
and lastly updates the entity name files.</p>
<p>Returns None.</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/load/load_generic.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_generic</span><span class="p">(</span><span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">schema_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">bad_addresses</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads a generic file into the database.</span>

<span class="sd">    Reads config file, loops through each file listed, cleans the data,</span>
<span class="sd">    creates a unique id for name, street, and street_name,</span>
<span class="sd">    loads into cleaned files into a database using the schema name from the config file,</span>
<span class="sd">    and lastly updates the entity name files.</span>

<span class="sd">    Returns None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">schema_name</span> <span class="o">=</span> <span class="n">schema_config</span><span class="p">[</span><span class="s2">&quot;schema_name&quot;</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">table_config</span> <span class="ow">in</span> <span class="n">schema_config</span><span class="p">[</span><span class="s2">&quot;tables&quot;</span><span class="p">]:</span>
            <span class="c1"># Read the data</span>
            <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow] Data: </span><span class="si">{</span><span class="n">table_config</span><span class="p">[</span><span class="s1">&#39;table_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -- Reading data&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data: </span><span class="si">{</span><span class="n">table_config</span><span class="p">[</span><span class="s1">&#39;table_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -- Reading data&quot;</span><span class="p">)</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">table_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;table_name_path&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No file path provided for table: </span><span class="si">{</span><span class="n">table_config</span><span class="p">[</span><span class="s1">&#39;table_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data file not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">file_extension</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">file_extension</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;parquet&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file format: </span><span class="si">{</span><span class="n">file_extension</span><span class="si">}</span><span class="s2">. Supported formats: csv, parquet&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">infer_schema</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span>
                    <span class="k">else</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># convert all columns to string</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading file </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

            <span class="n">validate_input_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">table_config</span><span class="p">)</span>

            <span class="c1"># Clean the data and create ids</span>
            <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;[yellow] Data: </span><span class="si">{</span><span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -- Starting cleaning&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;Data: </span><span class="si">{</span><span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -- Starting cleaning&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="n">all_columns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">all_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;id_col_og&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name_cols_og&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="n">all_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;address_cols_og&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="n">all_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

            <span class="c1"># Make headers snake case</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="c1"># df.columns = df.columns.str, regex=True)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">clean_generic</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">table_config</span><span class="p">)</span>

            <span class="c1"># load the data to db</span>
            <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;[yellow] Data: </span><span class="si">{</span><span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -- Starting load&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="n">table_name</span> <span class="o">=</span> <span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">]</span>
            <span class="n">load_to_db</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
                <span class="n">db_conn</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span>
                <span class="n">schema</span><span class="o">=</span><span class="n">schema_name</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># add new names to entity_names table</span>
            <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;[yellow] Data: </span><span class="si">{</span><span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -- Updating entity name tables&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;Data: </span><span class="si">{</span><span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -- Updating entity name tables&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="n">all_id_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name_id&quot;</span><span class="p">,</span> <span class="s2">&quot;address_id&quot;</span><span class="p">,</span> <span class="s2">&quot;street_id&quot;</span><span class="p">,</span> <span class="s2">&quot;street_name_id&quot;</span><span class="p">]</span>

            <span class="n">id_cols</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">col</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_id_cols</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;subaddress_identifier&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                    <span class="n">id_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">id_cols</span><span class="p">:</span>
                <span class="n">update_entity_ids</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">entity_id_col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">db_conn</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span>

            <span class="c1"># create bad address flag</span>
            <span class="k">if</span> <span class="n">table_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;address_cols&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;address_cols&quot;</span><span class="p">]:</span>
                    <span class="n">execute_flag_bad_addresses</span><span class="p">(</span>
                        <span class="n">db_conn</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span>
                        <span class="n">table</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">schema_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">address_col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
                        <span class="n">bad_addresses</span><span class="o">=</span><span class="n">bad_addresses</span><span class="p">,</span>
                    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="chainlink.load.load_utils" class="doc doc-heading">
            <code>load_utils</code>


<a href="#chainlink.load.load_utils" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="chainlink.load.load_utils.clean_generic" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clean_generic</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></code>

<a href="#chainlink.load.load_utils.clean_generic" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Cleans the name and address for a generic file. Appends a new
column with the cleaned name and address.</p>
<p>Returns a pl.DataFrame</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/load/load_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clean_generic</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cleans the name and address for a generic file. Appends a new</span>
<span class="sd">    column with the cleaned name and address.</span>

<span class="sd">    Returns a pl.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Clean the name</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;name_cols&quot;</span><span class="p">]:</span>
        <span class="c1"># lower snake case</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>

        <span class="n">raw_name</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;_raw&quot;</span>
        <span class="n">id_col_name</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;_name&quot;</span>

        <span class="c1"># weird case TODO</span>
        <span class="k">if</span> <span class="n">raw_name</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">raw_name</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="n">raw_name</span><span class="p">})</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">raw_name</span><span class="p">)</span>
                <span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">to_uppercase</span><span class="p">()</span>
                <span class="o">.</span><span class="n">map_elements</span><span class="p">(</span><span class="n">clean_names</span><span class="p">,</span> <span class="n">return_dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">)</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">id_col_name</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">create_id_col</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">id_col_name</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">id_col_name</span><span class="p">)</span>

    <span class="c1"># Clean the address</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;address_cols&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;address_cols&quot;</span><span class="p">]:</span>
            <span class="c1"># lower snake case</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>

            <span class="n">raw_address</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;_raw&quot;</span>
            <span class="n">temp_address</span> <span class="o">=</span> <span class="s2">&quot;temp_&quot;</span> <span class="o">+</span> <span class="n">col</span>
            <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow] Cleaning address column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">to_uppercase</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">raw_address</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">to_uppercase</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">temp_address</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">temp_address</span><span class="p">)</span><span class="o">.</span><span class="n">map_elements</span><span class="p">(</span>
                    <span class="n">clean_address</span><span class="p">,</span>
                    <span class="n">return_dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">Struct</span><span class="p">([</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">),</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="s2">&quot;address_number&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">),</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="s2">&quot;street_pre_directional&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">),</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="s2">&quot;street_name&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">),</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="s2">&quot;street_post_type&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">),</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="s2">&quot;unit_type&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">),</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="s2">&quot;unit_number&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">),</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="s2">&quot;subaddress_type&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">),</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="s2">&quot;subaddress_identifier&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">),</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="s2">&quot;city&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">),</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">),</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="s2">&quot;postal_code&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">),</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="s2">&quot;street&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">),</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="s2">&quot;address_norm&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">),</span>
                    <span class="p">]),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">ta_fields</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">temp_address</span><span class="p">]</span><span class="o">.</span><span class="n">struct</span><span class="o">.</span><span class="n">fields</span>
            <span class="n">new_fields</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ta_fields</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">raw_address</span><span class="p">)</span>
                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">temp_address</span><span class="p">)</span><span class="o">.</span><span class="n">struct</span><span class="o">.</span><span class="n">rename_fields</span><span class="p">(</span><span class="n">new_fields</span><span class="p">))</span>
                <span class="o">.</span><span class="n">unnest</span><span class="p">(</span><span class="n">temp_address</span><span class="p">)</span>
                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_postal_code&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">)</span><span class="o">.</span><span class="n">map_elements</span><span class="p">(</span><span class="n">clean_zipcode</span><span class="p">,</span> <span class="n">return_dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_address_norm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;_address&quot;</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;_address&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="n">id_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;address&quot;</span><span class="p">,</span> <span class="s2">&quot;street&quot;</span><span class="p">,</span> <span class="s2">&quot;street_name&quot;</span><span class="p">]</span>

            <span class="c1"># create id col</span>
            <span class="k">for</span> <span class="n">id_col</span> <span class="ow">in</span> <span class="n">id_cols</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">id_col</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">create_id_col</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># drop temp cols</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;_address&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.load.load_utils.create_id_col" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_id_col</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span></code>

<a href="#chainlink.load.load_utils.create_id_col" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Adds an id column to the DataFrame using pl.Series.hash function</p>
<p>Returns a pl.DataFrame</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/load/load_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_id_col</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds an id column to the DataFrame using pl.Series.hash function</span>

<span class="sd">    Returns a pl.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">col_id</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;_id&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">hash</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">col_id</span><span class="p">))</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">())</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col_id</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">col_id</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt64</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.load.load_utils.execute_flag_bad_addresses" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute_flag_bad_addresses</span><span class="p">(</span><span class="n">db_conn</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">address_col</span><span class="p">,</span> <span class="n">bad_addresses</span><span class="p">)</span></code>

<a href="#chainlink.load.load_utils.execute_flag_bad_addresses" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Flags rows with bad addresses as provided by user</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/load/load_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute_flag_bad_addresses</span><span class="p">(</span><span class="n">db_conn</span><span class="p">:</span> <span class="n">DuckDBPyConnection</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">address_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bad_addresses</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flags rows with bad addresses as provided by user</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow] Flagging bad addresses in </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> table for </span><span class="si">{</span><span class="n">address_col</span><span class="si">}</span><span class="s2"> column&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bad_addresses</span><span class="p">:</span>
        <span class="n">bad_addresses_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bad_addresses</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE OR REPLACE TABLE </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> AS</span>
<span class="s2">                SELECT *,</span>
<span class="s2">                        CASE WHEN</span>
<span class="s2">                            (</span><span class="si">{</span><span class="n">address_col</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">bad_addresses_tuple</span><span class="si">}</span>
<span class="s2">                            OR </span><span class="si">{</span><span class="n">address_col</span><span class="si">}</span><span class="s2">_street in </span><span class="si">{</span><span class="n">bad_addresses_tuple</span><span class="si">}</span><span class="s2">) THEN 1</span>
<span class="s2">                        ELSE 0 END as </span><span class="si">{</span><span class="n">address_col</span><span class="si">}</span><span class="s2">_skip</span>
<span class="s2">                from </span><span class="si">{</span><span class="n">table</span><span class="si">}</span>
<span class="s2">                &quot;&quot;&quot;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE OR REPLACE TABLE </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> AS</span>
<span class="s2">            SELECT *, 0 as </span><span class="si">{</span><span class="n">address_col</span><span class="si">}</span><span class="s2">_skip</span>
<span class="s2">            from </span><span class="si">{</span><span class="n">table</span><span class="si">}</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow] No bad addresses to flag in </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> table for </span><span class="si">{</span><span class="n">address_col</span><span class="si">}</span><span class="s2"> column&quot;</span><span class="p">)</span>

    <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.load.load_utils.load_to_db" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_to_db</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">db_conn</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span></code>

<a href="#chainlink.load.load_utils.load_to_db" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Loads parquet file into table in database.</p>
<h6 id="chainlink.load.load_utils.load_to_db--parameters">Parameters<a class="headerlink" href="#chainlink.load.load_utils.load_to_db--parameters" title="Permanent link">&para;</a></h6>
<p>filepath : str
    Directory of parquet file to load onto database.
table_name : str
    Name of resulting table in database.
db_conn : object
    Connection object to desired duckdb database.
schema : str
    Name of schema for resulting table in database.</p>
<h6 id="chainlink.load.load_utils.load_to_db--returns">Returns<a class="headerlink" href="#chainlink.load.load_utils.load_to_db--returns" title="Permanent link">&para;</a></h6>
<p>None</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/load/load_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_to_db</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">db_conn</span><span class="p">:</span> <span class="n">DuckDBPyConnection</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads parquet file into table in database.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath : str</span>
<span class="sd">        Directory of parquet file to load onto database.</span>
<span class="sd">    table_name : str</span>
<span class="sd">        Name of resulting table in database.</span>
<span class="sd">    db_conn : object</span>
<span class="sd">        Connection object to desired duckdb database.</span>
<span class="sd">    schema : str</span>
<span class="sd">        Name of schema for resulting table in database.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE SCHEMA IF NOT EXISTS </span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">;</span>
<span class="s2">            DROP TABLE IF EXISTS </span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">;</span>
<span class="s2">            CREATE TABLE </span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> AS</span>
<span class="s2">               SELECT *</span>
<span class="s2">               FROM df;</span>
<span class="s2">            &quot;&quot;&quot;</span>

    <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.load.load_utils.update_entity_ids" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_entity_ids</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">entity_id_col</span><span class="p">,</span> <span class="n">db_conn</span><span class="p">)</span></code>

<a href="#chainlink.load.load_utils.update_entity_ids" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Adds new ids to the entity schema table. If the value is already in the table, it is not added.</p>
<p>Returns None</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/load/load_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_entity_ids</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">entity_id_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">db_conn</span><span class="p">:</span> <span class="n">DuckDBPyConnection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds new ids to the entity schema table. If the value is already in the table, it is not added.</span>

<span class="sd">    Returns None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">split_col</span> <span class="o">=</span> <span class="n">entity_id_col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split_col</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span> <span class="o">==</span> <span class="s2">&quot;street_name_id&quot;</span><span class="p">:</span>
        <span class="n">entity_table_name</span> <span class="o">=</span> <span class="s2">&quot;street_name&quot;</span>
        <span class="n">entity_col</span> <span class="o">=</span> <span class="n">entity_id_col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split_col</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span> <span class="o">==</span> <span class="s2">&quot;street_id&quot;</span><span class="p">:</span>
        <span class="n">entity_table_name</span> <span class="o">=</span> <span class="s2">&quot;street&quot;</span>
        <span class="n">entity_col</span> <span class="o">=</span> <span class="n">entity_id_col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split_col</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span> <span class="o">==</span> <span class="s2">&quot;address_id&quot;</span><span class="p">:</span>
        <span class="n">entity_col</span> <span class="o">=</span> <span class="n">entity_id_col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_address_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">entity_table_name</span> <span class="o">=</span> <span class="s2">&quot;address&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split_col</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span> <span class="o">==</span> <span class="s2">&quot;name_id&quot;</span><span class="p">:</span>
        <span class="n">entity_col</span> <span class="o">=</span> <span class="n">entity_id_col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_name_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">entity_table_name</span> <span class="o">=</span> <span class="s2">&quot;name&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_table_exists</span><span class="p">(</span><span class="n">db_conn</span><span class="p">,</span> <span class="s2">&quot;entity&quot;</span><span class="p">,</span> <span class="n">entity_table_name</span><span class="p">):</span>
        <span class="c1"># a check if entity tables doesnt exist, just creates it</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE SCHEMA IF NOT EXISTS entity;</span>

<span class="s2">                CREATE TABLE entity.</span><span class="si">{</span><span class="n">entity_table_name</span><span class="si">}</span><span class="s2"> AS</span>
<span class="s2">                    SELECT </span><span class="si">{</span><span class="n">entity_col</span><span class="si">}</span><span class="s2"> as entity,</span>
<span class="s2">                           </span><span class="si">{</span><span class="n">entity_id_col</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">entity_table_name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="si">}</span>
<span class="s2">                    from  df</span>
<span class="s2">                ;</span>
<span class="s2">                &quot;&quot;&quot;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># otherwise, add any new entities to the existing table</span>

        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE OR REPLACE TABLE entity.</span><span class="si">{</span><span class="n">entity_table_name</span><span class="si">}</span><span class="s2"> AS (</span>


<span class="s2">                SELECT </span><span class="si">{</span><span class="n">entity_col</span><span class="si">}</span><span class="s2"> as entity,</span>
<span class="s2">                       </span><span class="si">{</span><span class="n">entity_id_col</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">entity_table_name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="si">}</span>
<span class="s2">                from  df</span>

<span class="s2">                UNION DISTINCT</span>

<span class="s2">                select entity,</span>
<span class="s2">                       </span><span class="si">{</span><span class="n">entity_table_name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;_id&quot;</span><span class="si">}</span>
<span class="s2">                from   entity.</span><span class="si">{</span><span class="n">entity_table_name</span><span class="si">}</span>
<span class="s2">                )</span>
<span class="s2">                &quot;&quot;&quot;</span>
    <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chainlink.load.load_utils.validate_input_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_input_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">table_config</span><span class="p">)</span></code>

<a href="#chainlink.load.load_utils.validate_input_data" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Validates input data against configuration requirements</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/load/load_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_input_data</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">table_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validates input data against configuration requirements</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">required_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">required_columns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;id_col_og&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">table_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name_cols_og&quot;</span><span class="p">):</span>
        <span class="n">required_columns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;name_cols_og&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">table_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;address_cols_og&quot;</span><span class="p">):</span>
        <span class="n">required_columns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">table_config</span><span class="p">[</span><span class="s2">&quot;address_cols_og&quot;</span><span class="p">])</span>

    <span class="n">missing_columns</span> <span class="o">=</span> <span class="n">required_columns</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required columns: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Check for empty dataframe</span>
    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input data is empty&quot;</span><span class="p">)</span>

    <span class="c1"># Check for minimum required non-null values</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span><span class="p">:</span>
        <span class="n">null_count</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">null_count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> contains all null values&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="chainlink.main" class="doc doc-heading">
            <code>main</code>


<a href="#chainlink.main" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="chainlink.main.chainlink" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">chainlink</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="n">DIR</span> <span class="o">/</span> <span class="s1">&#39;configs/config.yaml&#39;</span><span class="p">)</span></code>

<a href="#chainlink.main.chainlink" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Given a correctly formatted config file,
    * load in any schemas in the config that are not already in the database
    * create within links for each new schema
    * create across links for each new schema with all existing schemas</p>
<p>Returns true if the database was created successfully.</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">chainlink</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">DIR</span> <span class="o">/</span> <span class="s2">&quot;configs/config.yaml&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a correctly formatted config file,</span>
<span class="sd">        * load in any schemas in the config that are not already in the database</span>
<span class="sd">        * create within links for each new schema</span>
<span class="sd">        * create across links for each new schema with all existing schemas</span>


<span class="sd">    Returns true if the database was created successfully.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">probabilistic</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;probabilistic&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">load_only</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;load_only&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">db_path</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db_path&quot;</span><span class="p">,</span> <span class="n">DIR</span> <span class="o">/</span> <span class="s2">&quot;db/linked.db&quot;</span><span class="p">)</span>

    <span class="n">no_names</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">no_addresses</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># create snake case columns</span>
    <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;schemas&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;tables&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;name_cols&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">no_names</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">table</span><span class="p">[</span><span class="s2">&quot;name_cols_og&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;name_cols&quot;</span><span class="p">]</span>
                <span class="n">table</span><span class="p">[</span><span class="s2">&quot;name_cols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;name_cols&quot;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">table</span><span class="p">[</span><span class="s2">&quot;name_cols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;address_cols&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">no_addresses</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">table</span><span class="p">[</span><span class="s2">&quot;address_cols_og&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;address_cols&quot;</span><span class="p">]</span>
                <span class="n">table</span><span class="p">[</span><span class="s2">&quot;address_cols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;address_cols&quot;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">table</span><span class="p">[</span><span class="s2">&quot;address_cols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col_og&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">]</span>
            <span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>

    <span class="c1"># handle options</span>
    <span class="n">overwrite_db</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overwrite_db&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">overwrite_db</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">db_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red] Removed existing database at </span><span class="si">{</span><span class="n">db_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed existing database at </span><span class="si">{</span><span class="n">db_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">update_config_only</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;update_config_only&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">update_config_only</span><span class="p">:</span>
        <span class="n">update_config</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">config_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="n">bad_address_path</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bad_address_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bad_address_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bad_addresses_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">bad_address_path</span><span class="p">)</span>
            <span class="n">bad_addresses</span> <span class="o">=</span> <span class="n">bad_addresses_df</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">bad_addresses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bad_addresses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># list of link exclusions</span>

    <span class="n">link_exclusions</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;link_exclusions&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">link_exclusions</span><span class="p">:</span>
        <span class="n">link_exclusions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># all columns in db to compare against</span>
    <span class="k">with</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
        <span class="n">df_db_columns</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;show all tables&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span>

    <span class="n">schemas</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;schemas&quot;</span><span class="p">]</span>
    <span class="n">new_schemas</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># load each schema. if schema is a new entity, create links</span>
    <span class="k">for</span> <span class="n">schema_config</span> <span class="ow">in</span> <span class="n">schemas</span><span class="p">:</span>
        <span class="n">schema_name</span> <span class="o">=</span> <span class="n">schema_config</span><span class="p">[</span><span class="s2">&quot;schema_name&quot;</span><span class="p">]</span>

        <span class="c1"># if not force create, check if each col exists, and skip if so</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite_db</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">df_db_columns</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">schema_name</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_schemas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">schema_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_schemas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">schema_name</span><span class="p">)</span>

    <span class="c1"># load in all new schemas</span>
    <span class="k">for</span> <span class="n">new_schema</span> <span class="ow">in</span> <span class="n">new_schemas</span><span class="p">:</span>
        <span class="n">schema_config</span> <span class="o">=</span> <span class="p">[</span><span class="n">schema</span> <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">schemas</span> <span class="k">if</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;schema_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_schema</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">with</span> <span class="n">console</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold yellow] Working on loading </span><span class="si">{</span><span class="n">new_schema</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">status</span><span class="p">:</span>
            <span class="c1"># load schema</span>
            <span class="n">load_generic</span><span class="p">(</span>
                <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
                <span class="n">schema_config</span><span class="o">=</span><span class="n">schema_config</span><span class="p">,</span>
                <span class="n">bad_addresses</span><span class="o">=</span><span class="n">bad_addresses</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">load_only</span><span class="p">:</span>
            <span class="c1"># create exact links</span>
            <span class="k">with</span> <span class="n">console</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold yellow] Working on linking </span><span class="si">{</span><span class="n">new_schema</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">create_within_links</span><span class="p">(</span>
                    <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
                    <span class="n">schema_config</span><span class="o">=</span><span class="n">schema_config</span><span class="p">,</span>
                    <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">load_only</span> <span class="ow">and</span> <span class="n">probabilistic</span><span class="p">:</span>
        <span class="c1">#  generate all the fuzzy links and store in entity.name_similarity</span>
        <span class="c1"># only if there are new schemas added</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_schemas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">console</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;[bold yellow] Working on fuzzy matching scores&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">status</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">no_names</span><span class="p">:</span>
                    <span class="n">generate_tfidf_links</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">table_location</span><span class="o">=</span><span class="s2">&quot;entity.name_similarity&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">no_addresses</span><span class="p">:</span>
                    <span class="n">generate_tfidf_links</span><span class="p">(</span>
                        <span class="n">db_path</span><span class="p">,</span>
                        <span class="n">table_location</span><span class="o">=</span><span class="s2">&quot;entity.street_name_similarity&quot;</span><span class="p">,</span>
                        <span class="n">source_table_name</span><span class="o">=</span><span class="s2">&quot;entity.street_name&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="c1"># for across link</span>
        <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">created_schemas</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># create tfidf links within each new schema</span>
        <span class="k">for</span> <span class="n">new_schema</span> <span class="ow">in</span> <span class="n">new_schemas</span><span class="p">:</span>
            <span class="n">schema_config</span> <span class="o">=</span> <span class="p">[</span><span class="n">schema</span> <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">schemas</span> <span class="k">if</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;schema_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_schema</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">probabilistic</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">console</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold yellow] Working on fuzzy matching links in </span><span class="si">{</span><span class="n">new_schema</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">status</span><span class="p">:</span>
                    <span class="n">create_tfidf_within_links</span><span class="p">(</span>
                        <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
                        <span class="n">schema_config</span><span class="o">=</span><span class="n">schema_config</span><span class="p">,</span>
                        <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="c1"># also create across links for each new schema</span>
            <span class="n">existing_schemas</span> <span class="o">=</span> <span class="p">[</span><span class="n">schema</span> <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">schemas</span> <span class="k">if</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;schema_name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_schema</span><span class="p">]</span>

            <span class="n">new_schema_config</span> <span class="o">=</span> <span class="p">[</span><span class="n">schema</span> <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">schemas</span> <span class="k">if</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;schema_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_schema</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># make sure we havent already created this link combo</span>
            <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">existing_schemas</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">new_schema</span> <span class="o">+</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;schema_name&quot;</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">created_schemas</span><span class="p">:</span>
                    <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">new_schema_config</span><span class="p">,</span> <span class="n">schema</span><span class="p">))</span>
                    <span class="n">created_schemas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">new_schema</span> <span class="o">+</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;schema_name&quot;</span><span class="p">]))</span>

        <span class="c1"># across links for each new_schema, link across to all existing entities</span>
        <span class="k">for</span> <span class="n">new_schema_config</span><span class="p">,</span> <span class="n">existing_schema</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">console</span><span class="o">.</span><span class="n">status</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[bold yellow] Working on links between </span><span class="si">{</span><span class="n">new_schema_config</span><span class="p">[</span><span class="s1">&#39;schema_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">existing_schema</span><span class="p">[</span><span class="s1">&#39;schema_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">create_across_links</span><span class="p">(</span>
                    <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
                    <span class="n">new_schema</span><span class="o">=</span><span class="n">new_schema_config</span><span class="p">,</span>
                    <span class="n">existing_schema</span><span class="o">=</span><span class="n">existing_schema</span><span class="p">,</span>
                    <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">probabilistic</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">console</span><span class="o">.</span><span class="n">status</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[bold yellow] Working on fuzzy links between </span><span class="si">{</span><span class="n">new_schema_config</span><span class="p">[</span><span class="s1">&#39;schema_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">existing_schema</span><span class="p">[</span><span class="s1">&#39;schema_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">status</span><span class="p">:</span>
                    <span class="n">create_tfidf_across_links</span><span class="p">(</span>
                        <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span>
                        <span class="n">new_schema</span><span class="o">=</span><span class="n">new_schema_config</span><span class="p">,</span>
                        <span class="n">existing_schema</span><span class="o">=</span><span class="n">existing_schema</span><span class="p">,</span>
                        <span class="n">link_exclusions</span><span class="o">=</span><span class="n">link_exclusions</span><span class="p">,</span>
                    <span class="p">)</span>

    <span class="n">update_config</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">config_path</span><span class="p">)</span>

    <span class="n">export_tables_flag</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;export_tables&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">export_tables_flag</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">DIR</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;export&quot;</span>
        <span class="n">export_tables</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>  <span class="c1">## TODO: check if this is true or false</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="chainlink.main.main" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">main</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="n">DIR</span> <span class="o">/</span> <span class="s1">&#39;config&#39;</span> <span class="o">/</span> <span class="s1">&#39;chainlink_config.yaml&#39;</span><span class="p">,</span> <span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readable</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span></code>

<a href="#chainlink.main.main" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Given a correctly formatted config file,
    * load in any schemas in the config that are not already in the database
    * create within links for each new schema
    * create across links for each new schema with all existing schemas</p>
<p>Returns 'True' if the database was created successfully.</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="n">DIR</span> <span class="o">/</span> <span class="s2">&quot;config&quot;</span> <span class="o">/</span> <span class="s2">&quot;chainlink_config.yaml&quot;</span><span class="p">,</span> <span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readable</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a correctly formatted config file,</span>
<span class="sd">        * load in any schemas in the config that are not already in the database</span>
<span class="sd">        * create within links for each new schema</span>
<span class="sd">        * create across links for each new schema with all existing schemas</span>

<span class="sd">    Returns &#39;True&#39; if the database was created successfully.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_dict</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">else</span> <span class="n">create_config</span><span class="p">()</span>
    <span class="n">chainlink</span><span class="p">(</span><span class="n">config_dict</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[green bold] chainlink complete, database created&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;chainlink complete, database created&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="chainlink.utils" class="doc doc-heading">
            <code>utils</code>


<a href="#chainlink.utils" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="chainlink.utils.add_schema_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_schema_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code>

<a href="#chainlink.utils.add_schema_config" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Helper to add a schema to an existing config</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_schema_config</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper to add a schema to an existing config</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">schema_name</span> <span class="o">=</span> <span class="n">Prompt</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;[green]&gt; Enter the name of the schema&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;schemas&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;schema_name&quot;</span><span class="p">:</span> <span class="n">schema_name</span><span class="p">,</span> <span class="s2">&quot;tables&quot;</span><span class="p">:</span> <span class="p">[]})</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">add_table_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">schema_name</span><span class="p">)</span>
    <span class="n">add_table</span> <span class="o">=</span> <span class="n">Confirm</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;[green]&gt; Add a table to this schema?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">add_table</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">add_table_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">schema_name</span><span class="p">)</span>
        <span class="n">add_table</span> <span class="o">=</span> <span class="n">Confirm</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span>
            <span class="s2">&quot;[green]&gt; Add another table to this schema?&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[green italic]&gt; Schema added successfully!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="chainlink.utils.add_table_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_table_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">schema_name</span><span class="p">)</span></code>

<a href="#chainlink.utils.add_table_config" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Helper to add a table to an existing schema</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_table_config</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">schema_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper to add a table to an existing schema</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">table_name</span> <span class="o">=</span> <span class="n">Prompt</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;[green]&gt; Enter the name of dataset:&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="n">table_name_path</span> <span class="o">=</span> <span class="n">Prompt</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;[green]&gt; Enter the path to the dataset&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">table_name_path</span><span class="p">):</span>
        <span class="n">table_name_path</span> <span class="o">=</span> <span class="n">Prompt</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;[red]&gt; Path does not exist. Please enter a valid path&quot;</span><span class="p">)</span>
    <span class="n">id_col</span> <span class="o">=</span> <span class="n">Prompt</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;[green]&gt; Enter the id column of the dataset. Must be unique&quot;</span><span class="p">)</span>
    <span class="n">name_col_str</span> <span class="o">=</span> <span class="n">Prompt</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;[green]&gt; Enter the name column(s) (comma separated)&quot;</span><span class="p">)</span>
    <span class="n">name_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">name_col_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
    <span class="n">address_col_str</span> <span class="o">=</span> <span class="n">Prompt</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;[green]&gt; Enter the address column(s) (comma separated)&quot;</span><span class="p">)</span>
    <span class="n">address_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">address_col_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;schemas&quot;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;schema_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">schema_name</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;schemas&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;tables&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;table_name&quot;</span><span class="p">:</span> <span class="n">table_name</span><span class="p">,</span>
                <span class="s2">&quot;table_name_path&quot;</span><span class="p">:</span> <span class="n">table_name_path</span><span class="p">,</span>
                <span class="s2">&quot;id_col&quot;</span><span class="p">:</span> <span class="n">id_col</span><span class="p">,</span>
                <span class="s2">&quot;name_cols&quot;</span><span class="p">:</span> <span class="n">name_cols</span><span class="p">,</span>
                <span class="s2">&quot;address_cols&quot;</span><span class="p">:</span> <span class="n">address_cols</span><span class="p">,</span>
            <span class="p">})</span>

    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="chainlink.utils.check_table_exists" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">check_table_exists</span><span class="p">(</span><span class="n">db_conn</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span></code>

<a href="#chainlink.utils.check_table_exists" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>check if a table exists</p>
<p>Returns: bool</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_table_exists</span><span class="p">(</span><span class="n">db_conn</span><span class="p">:</span> <span class="n">DuckDBPyConnection</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    check if a table exists</span>

<span class="sd">    Returns: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;    SELECT COUNT(*)</span>
<span class="s2">                FROM   information_schema.tables</span>
<span class="s2">                WHERE  table_name = &#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">                AND    table_schema = &#39;</span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">&#39;&quot;&quot;&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">db_conn</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="chainlink.utils.create_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_config</span><span class="p">()</span></code>

<a href="#chainlink.utils.create_config" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Helper to create config file from user input if not pre created</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_config</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper to create config file from user input if not pre created</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">create_config_path</span> <span class="o">=</span> <span class="n">Prompt</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span>
        <span class="s2">&quot;[green]&gt; Enter config path. [Leave blank if you would you like to create a new one]&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">show_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">create_config_path</span> <span class="o">=</span> <span class="n">create_config_path</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">create_config_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">create_config_path</span><span class="p">):</span>
            <span class="n">create_config_path</span> <span class="o">=</span> <span class="n">Prompt</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;[red]&gt; Yaml path does not exist. Please enter a valid path&quot;</span><span class="p">)</span>
            <span class="n">create_config_path</span> <span class="o">=</span> <span class="n">create_config_path</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">create_config_path</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">validate_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># invalid config</span>
                <span class="c1"># print(validate_config(config))</span>
                <span class="n">create_config_path</span> <span class="o">=</span> <span class="n">Prompt</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;[red]&gt; Invalid config. Please enter a valid yaml config&quot;</span><span class="p">)</span>
                <span class="n">create_config_path</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">create_config_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">config</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;overwrite_db&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;export_tables&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;update_config_only&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;link_exclusions&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;bad_address_path&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;probabilistic&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;load_only&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;schemas&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="c1"># build config with user input</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">][</span><span class="s2">&quot;db_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Prompt</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span>
            <span class="s2">&quot;[green]&gt; Enter the path to the resulting database&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;db/linked.db&quot;</span><span class="p">,</span>
            <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">][</span><span class="s2">&quot;load_only&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Confirm</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span>
            <span class="s2">&quot;[green]&gt; Only clean and load data to the database (without matching)?&quot;</span><span class="p">,</span>
            <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">][</span><span class="s2">&quot;load_only&quot;</span><span class="p">]:</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">][</span><span class="s2">&quot;probablistic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Confirm</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span>
                <span class="s2">&quot;[green]&gt; Run probabilisitic name and address matching?&quot;</span><span class="p">,</span>
                <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">][</span><span class="s2">&quot;export_tables&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Confirm</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span>
            <span class="s2">&quot;[green]&gt; Export tables to parquet after load?&quot;</span><span class="p">,</span>
            <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">bad_address_path</span> <span class="o">=</span> <span class="n">Prompt</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span>
            <span class="s2">&quot;[dim green]&gt; [Optional] Provide path to bad address csv file&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">show_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">bad_address_path</span> <span class="o">=</span> <span class="n">bad_address_path</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">bad_address_path</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bad_address_path</span><span class="p">):</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;&gt; Bad address path does not exist. Please enter a valid path or leave blank:&quot;</span><span class="p">)</span>
                <span class="n">bad_address_path</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">][</span><span class="s2">&quot;bad_address_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bad_address_path</span>

        <span class="n">add_schema</span> <span class="o">=</span> <span class="n">Confirm</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;[green]&gt; Add a new schema?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">add_schema</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">add_schema_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="n">add_schema</span> <span class="o">=</span> <span class="n">Confirm</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;&gt; Add another schema?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="chainlink.utils.export_tables" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">export_tables</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">data_path</span><span class="p">)</span></code>

<a href="#chainlink.utils.export_tables" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>export all tables from database to parquet files in {data_path}/export directory</p>
<p>Returns: None</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export_tables</span><span class="p">(</span><span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">data_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    export all tables from database to parquet files in {data_path}/export directory</span>

<span class="sd">    Returns: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># create export directory if doesn&#39;t exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_id_cols</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>  <span class="c1"># TODO: check if this is correct</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;link&quot;</span> <span class="ow">or</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;name_similarity&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;column_names&quot;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;entity&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;column_names&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;column_names&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">with</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">df_db_columns</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;show all tables&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span>

        <span class="n">df_db_columns</span> <span class="o">=</span> <span class="n">df_db_columns</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">schema_table</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
            <span class="n">id_col</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">all</span><span class="p">())</span><span class="o">.</span><span class="n">map_elements</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">find_id_cols</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">return_dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="n">link_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;link&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;name_similarity&quot;</span><span class="p">)</span>

        <span class="n">links_to_export</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">df_db_columns</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">link_filter</span><span class="p">)[</span><span class="s2">&quot;schema_table&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
            <span class="n">df_db_columns</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">link_filter</span><span class="p">)[</span><span class="s2">&quot;id_col&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links_to_export</span><span class="p">:</span>
            <span class="n">links_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                (select * from </span><span class="si">{</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span>
<span class="s2">                order by </span><span class="si">{</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> ASC, </span><span class="si">{</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> ASC);</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">links_query</span><span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">({</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span> <span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span> <span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">})</span>
            <span class="n">d</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.parquet&quot;</span><span class="p">)</span>

        <span class="n">main_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;link&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;name_similarity&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">main_filter</span><span class="p">)</span>
        <span class="n">main_to_export</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">df_db_columns</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">main_filter</span><span class="p">)[</span><span class="s2">&quot;schema_table&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
            <span class="n">df_db_columns</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">main_filter</span><span class="p">)[</span><span class="s2">&quot;id_col&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">id_cols</span> <span class="ow">in</span> <span class="n">main_to_export</span><span class="p">:</span>
            <span class="n">sql_to_exec</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                (select * from </span><span class="si">{</span><span class="n">table</span><span class="si">}</span>
<span class="s2">                order by </span><span class="si">{</span><span class="n">id_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> ASC);</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_to_exec</span><span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">({</span><span class="n">id_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">})</span>
            <span class="n">d</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">table</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.parquet&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exported all tables!&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Exported all tables!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="chainlink.utils.load_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_config</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span></code>

<a href="#chainlink.utils.load_config" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>load yaml config file, clean up column names</p>
<p>Returns: dict</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_config</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    load yaml config file, clean up column names</span>

<span class="sd">    Returns: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="chainlink.utils.setup_logger" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">setup_logger</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">log_file</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span></code>

<a href="#chainlink.utils.setup_logger" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>To setup as many loggers as you want</p>
<h4 id="chainlink.utils.setup_logger--from-httpsstackoverflowcomquestions11232230logging-to-two-files-with-different-settings">from https://stackoverflow.com/questions/11232230/logging-to-two-files-with-different-settings<a class="headerlink" href="#chainlink.utils.setup_logger--from-httpsstackoverflowcomquestions11232230logging-to-two-files-with-different-settings" title="Permanent link">&para;</a></h4>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">setup_logger</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">log_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To setup as many loggers as you want</span>
<span class="sd">    # from https://stackoverflow.com/questions/11232230/logging-to-two-files-with-different-settings</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(levelname)s</span><span class="s2"> </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">logger</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="chainlink.utils.update_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_config</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">config_path</span><span class="p">)</span></code>

<a href="#chainlink.utils.update_config" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>update config by adding in all existing link columns and last updated time.
writes config back out to config.yaml</p>
<p>Returns: None</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_config</span><span class="p">(</span><span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    update config by adding in all existing link columns and last updated time.</span>
<span class="sd">    writes config back out to config.yaml</span>

<span class="sd">    Returns: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">df_db_columns</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;show all tables&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span>

    <span class="n">all_links</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cols</span> <span class="ow">in</span> <span class="n">df_db_columns</span><span class="p">[</span><span class="s2">&quot;column_names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
        <span class="n">all_links</span> <span class="o">+=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="s2">&quot;match&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>

    <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;existing_links&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_links</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="chainlink.utils.validate_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code>

<a href="#chainlink.utils.validate_config" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Validates the configuration against a schema</p>


            <details class="quote">
              <summary>Source code in <code>src/chainlink/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_config</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validates the configuration against a schema</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">,</span> <span class="s2">&quot;schemas&quot;</span><span class="p">],</span>
        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;db_path&quot;</span><span class="p">],</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;overwrite_db&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;export_tables&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;update_config_only&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;link_exclusions&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]},</span>  <span class="c1"># or none</span>
                    <span class="s2">&quot;bad_address_path&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>  <span class="c1"># or none</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="s2">&quot;schemas&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;schema_name&quot;</span><span class="p">,</span> <span class="s2">&quot;tables&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;schema_name&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                        <span class="s2">&quot;tables&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;table_name_path&quot;</span><span class="p">,</span> <span class="s2">&quot;id_col&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="s2">&quot;table_name&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                                    <span class="s2">&quot;table_name_path&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                                    <span class="s2">&quot;id_col&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                                    <span class="s2">&quot;name_cols&quot;</span><span class="p">:</span> <span class="p">{</span>
                                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                                    <span class="p">},</span>
                                    <span class="s2">&quot;address_cols&quot;</span><span class="p">:</span> <span class="p">{</span>
                                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                                    <span class="p">},</span>
                                <span class="p">},</span>
                            <span class="p">},</span>
                        <span class="p">},</span>
                    <span class="p">},</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">jsonschema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold red]&gt; Invalid configuration: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># ids across tables but within schema should be the same</span>
    <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;schemas&quot;</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;tables&quot;</span><span class="p">]:</span>
            <span class="n">ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold red]&gt; All tables in schema </span><span class="si">{</span><span class="n">schema</span><span class="p">[</span><span class="s1">&#39;schema_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> must have the same id column&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># no exception</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Maintained by Mansueto Institute</a>.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/mansueto-institute/mi-chainlink" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/mi-chainlink" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>